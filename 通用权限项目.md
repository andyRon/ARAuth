é€šç”¨æƒé™é¡¹ç›®
-----

https://www.bilibili.com/video/BV1ad4y1y7LU


## ä»‹ç»

### é¡¹ç›®èƒŒæ™¯

### å‰ç½®çŸ¥è¯†



## ä¸€ã€é¡¹ç›®ä»‹ç»

æƒé™ç®¡ç†æ˜¯æ‰€æœ‰åå°ç³»ç»Ÿéƒ½ä¼šæ¶‰åŠçš„ä¸€ä¸ªé‡è¦ç»„æˆéƒ¨åˆ†ï¼Œè€Œæƒé™ç®¡ç†çš„æ ¸å¿ƒæµç¨‹æ˜¯ç›¸ä¼¼çš„ï¼Œå¦‚æœæ¯ä¸ªåå°å•ç‹¬å¼€å‘ä¸€å¥—æƒé™ç®¡ç†ç³»ç»Ÿï¼Œå°±æ˜¯é‡å¤é€ è½®å­ï¼Œæ˜¯äººåŠ›çš„æå¤§æµªè´¹ï¼Œæœ¬é¡¹ç›®å°±æ˜¯é’ˆå¯¹è¿™ä¸ªé—®é¢˜ï¼Œæä¾›äº†ä¸€å¥—é€šç”¨çš„æƒé™è§£å†³æ–¹æ¡ˆã€‚

ç”¨æˆ·ç®¡ç†

è§’è‰²ç®¡ç†

èœå•ç®¡ç†

éƒ¨é—¨ç®¡ç†

å²—ä½ç®¡ç†

æ—¥å¿—ç®¡ç†

| åŸºç¡€æ¡†æ¶ï¼šSpringBoot                              |
| ------------------------------------------------- |
| æ•°æ®ç¼“å­˜ï¼šRedis                                   |
| æ•°æ®åº“ï¼šMysql                                     |
| æƒé™æ§åˆ¶ï¼šSpringSecurity                          |
| å…¨å±€æ—¥å¿—è®°å½•ï¼šAOP                                 |
| å‰ç«¯æ¨¡æ¿ï¼švue-admin-template                      |
| å‰ç«¯æŠ€æœ¯ï¼šNode.js + Npm + Vue + ElementUI + Axios |

### é¡¹ç›®æ¨¡å—

```
arauth-parentï¼šæ ¹ç›®å½•ï¼Œç®¡ç†å­æ¨¡å—ï¼š  # çˆ¶å·¥ç¨‹ pomç±»å‹ã€‚ä¾èµ–ç®¡ç†

    commonï¼šå…¬å…±ç±»çˆ¶æ¨¡å—

        common-logï¼šç³»ç»Ÿæ“ä½œæ—¥å¿—æ¨¡å—

        common-utilï¼šæ ¸å¿ƒå·¥å…·ç±»

        service-utilï¼šserviceæ¨¡å—å·¥å…·ç±»

        spring-securityï¼šspring-securityä¸šåŠ¡æ¨¡å—

    modelï¼šå®ä½“ç±»æ¨¡å—

    service-systemï¼šç³»ç»Ÿæƒé™æ¨¡å—
```



### æ•°æ®åº“è®¾è®¡

![](images/image-20230322010519208.png)

## äºŒã€æ­å»ºç¯å¢ƒ

### æ­å»ºå„ä¸ªæ¨¡å—



## Mybatis-Plus

![](images/image-20230326114412642.png)

![](images/image-20230326114444831.png)

1. å‡†å¤‡
   - springbooté…ç½®æ–‡ä»¶
   - å¯åŠ¨ç±»
   - å®ä½“ç±»
2. åˆ›å»ºmapper
   - mpå®ç°curdæ“ä½œ
     - åˆ›å»ºmapperçš„interface
     - mapperç»§æ‰¿BaseMapper<å®ä½“ç±»>
     - è°ƒç”¨mapperå°è£…çš„å®ç°å®ç°curdæ“ä½œ

3. åˆ›å»ºservice
   - åˆ›å»ºserviceæ¥å£ç»§æ‰¿IService
   - åˆ›å»ºserviceå®ç°ç±»ï¼Œç»§æ‰¿ServiceImpl



![](images/image-20230326114656897.png)



### MPæ¡ä»¶æ„é€ å™¨

![](images/image-20230326154316164.png)

Wrapper ï¼š æ¡ä»¶æ„é€ æŠ½è±¡ç±»ï¼Œæœ€é¡¶ç«¯çˆ¶ç±»

  AbstractWrapper ï¼š ç”¨äºæŸ¥è¯¢æ¡ä»¶å°è£…ï¼Œç”Ÿæˆ sql çš„ where æ¡ä»¶

â€‹    QueryWrapper ï¼š Entity å¯¹è±¡å°è£…æ“ä½œç±»ï¼Œä¸æ˜¯ç”¨lambdaè¯­æ³•

â€‹    UpdateWrapper ï¼š Update æ¡ä»¶å°è£…ï¼Œç”¨äºEntityå¯¹è±¡æ›´æ–°æ“ä½œ

  AbstractLambdaWrapper ï¼š Lambda è¯­æ³•ä½¿ç”¨ Wrapperç»Ÿä¸€å¤„ç†è§£æ lambda è·å– columnã€‚

â€‹    LambdaQueryWrapper ï¼šçœ‹åç§°ä¹Ÿèƒ½æ˜ç™½å°±æ˜¯ç”¨äºLambdaè¯­æ³•ä½¿ç”¨çš„æŸ¥è¯¢Wrapper

â€‹    LambdaUpdateWrapper ï¼š Lambda æ›´æ–°å°è£…Wrapper



### MPå°è£…serviceå±‚

MPä¹Ÿæ›¿æˆ‘ä»¬ï¼ŒæŠŠServiceè°ƒç”¨mapperè¿‡ç¨‹ å°è£…äº†

```java
@Service
public class SysRoleServiceImpl extends ServiceImpl<SysRoleMapper, SysRole> implements SysRoleService {
}

```

```java
public class ServiceImpl<M extends BaseMapper<T>, T> implements IService<T> {
    protected Log log = LogFactory.getLog(this.getClass());
    @Autowired
    protected M baseMapper;
```



> ![](images/image-20230326161220654.png)

## è§’è‰²ç®¡ç†

### controller

### æ•´åˆSwagger2

[knife4j](https://doc.xiaominfo.com/)æ˜¯ä¸ºJava MVCæ¡†æ¶é›†æˆSwaggerç”ŸæˆApiæ–‡æ¡£çš„å¢å¼ºè§£å†³æ–¹æ¡ˆã€‚

knife4jå±äºserviceæ¨¡å—å…¬å…±èµ„æºï¼Œå› æ­¤æˆ‘ä»¬é›†æˆåˆ°service-uitlæ¨¡å—



```xml
<dependency>
    <groupId>com.github.xiaoymin</groupId>
    <artifactId>knife4j-spring-boot-starter</artifactId>
</dependency>
```



knife4jæµ‹è¯•è·¯å¾„ http://localhost:8800/doc.html

### å®šä¹‰ç»Ÿä¸€è¿”å›ç»“æœå¯¹è±¡

common-utilæ¨¡å—



### æ¡ä»¶åˆ†é¡µæŸ¥è¯¢

1. é…ç½®åˆ†é¡µæ’ä»¶ï¼Œé€šè¿‡é…ç½®ç±»å®ç°



2. åˆ›å»ºcontrolleræ–¹æ³•

```java
    @ApiOperation(value = "æ¡ä»¶åˆ†é¡µæŸ¥è¯¢")
    @GetMapping("/{page}/{limit}")
    public Result findPageQueryRole(
            @ApiParam(name = "page", value = "å½“å‰é¡µç ", required = true)
            @PathVariable Long page,
            @ApiParam(name = "limit", value = "æ¯é¡µè®°å½•æ•°", required = true)
            @PathVariable Long limit,
            @ApiParam(name = "roleQueryVo", value = "æŸ¥è¯¢å¯¹è±¡", required = false)
            SysRoleQueryVo sysRoleQueryVo) {

        Page<SysRole> pageParam = new Page<>(page, limit);
        IPage<SysRole> pageModel = sysRoleService.selectPage(pageParam, sysRoleQueryVo);
        return Result.ok(pageModel);
    }
```



3. Serviceæ–¹æ³•

```java
    IPage<SysRole> selectPage(Page<SysRole> pageParam, SysRoleQueryVo sysRoleQueryVo);
```

```java
    @Override
    public IPage<SysRole> selectPage(Page<SysRole> pageParam, SysRoleQueryVo sysRoleQueryVo) {
        IPage<SysRole> pageModel = baseMapper.selectPage(pageParam, sysRoleQueryVo);
        return pageModel;
    }
```



4. mapperæ–¹æ³•

```java
    IPage<SysRole> selectPage(Page<SysRole> pageParam, @Param("vo") SysRoleQueryVo sysRoleQueryVo);

```



3. åˆ›å»ºmapperçš„xmlé…ç½®æ–‡ä»¶ï¼Œç¼–å†™sqlè¯­å¥å®ç°

åœ¨resourcesç›®å½•ä¸‹åˆ›å»ºmapper/SysRoleMapper.xmlæ–‡ä»¶

è¯´æ˜ï¼šåˆ†é¡µæˆ‘ä»¬ç»Ÿä¸€å®šä¹‰åˆ°xmlæ–‡ä»¶ä¸­ï¼Œæ›´æ–¹ä¾¿ç›´è§‚

```xml
<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.andyron.system.mapper.SysRoleMapper">

    <resultMap id="RoleMap" type="com.andyron.model.system.SysRole" autoMapping="true">
    </resultMap>


    <select id="selectPage" resultMap="RoleMap">
        select <include refid="columns" />
        from sys_role
        <where>
            <if test="vo.roleName != null and vo.roleName != ''">
                and role_name like CONCAT('%',#{vo.roleName},'%')
            </if>
            and is_deleted = 0
        </where>
        order by id desc
    </select>

</mapper>
```





### ç»Ÿä¸€å¼‚å¸¸å¤„ç†

service-util



#### å…¨å±€å¼‚å¸¸å¤„ç†



#### ç‰¹å®šå¼‚å¸¸å¤„ç†



#### è‡ªå®šä¹‰å¼‚å¸¸å¤„ç†



## å‰ç«¯åŸºç¡€çŸ¥è¯†



### VS Code

å¿«æ·é”®

```
!
å³å‡»æœåŠ¡å™¨æ‰“å¼€
```



### Node.js

å®˜ç½‘ï¼šhttps://nodejs.org/en/ 

ä¸­æ–‡ç½‘ï¼šhttp://nodejs.cn/ 

LTSï¼šé•¿æœŸæ”¯æŒç‰ˆæœ¬

Currentï¼šæœ€æ–°ç‰ˆ



æµè§ˆå™¨çš„å†…æ ¸åŒ…æ‹¬ä¸¤éƒ¨åˆ†æ ¸å¿ƒï¼š

- DOMæ¸²æŸ“å¼•æ“ï¼›
- jsè§£æå™¨ï¼ˆjså¼•æ“ï¼‰

jsè¿è¡Œåœ¨æµè§ˆå™¨ä¸­çš„å†…æ ¸ä¸­çš„jså¼•æ“å†…éƒ¨

Node.jsæ˜¯è„±ç¦»æµè§ˆå™¨ç¯å¢ƒè¿è¡Œçš„JavaScriptç¨‹åºï¼ŒåŸºäºV8 å¼•æ“ï¼ˆChrome çš„ JavaScriptçš„å¼•æ“ï¼‰



### NPM



```shell
npm init
npm init -y

# è®¾ç½®é•œåƒ
#ç»è¿‡ä¸‹é¢çš„é…ç½®ï¼Œä»¥åæ‰€æœ‰çš„ npm install éƒ½ä¼šç»è¿‡æ·˜å®çš„é•œåƒåœ°å€ä¸‹è½½
npm config set registry https://registry.npm.taobao.org 
#æŸ¥çœ‹npmé…ç½®ä¿¡æ¯
npm config list

npm install [åŒ…å]/[åŒ…å@2.2.x]
npm install 		# æ ¹æ®å½“å‰ç›®å½•ä¸‹é…ç½®æ–‡ä»¶package.jsonå®‰è£…
npm intall -g     # å…¨å±€å®‰è£…
#devDependenciesèŠ‚ç‚¹ï¼šå¼€å‘æ—¶çš„ä¾èµ–åŒ…ï¼Œé¡¹ç›®æ‰“åŒ…åˆ°ç”Ÿäº§ç¯å¢ƒçš„æ—¶å€™ä¸åŒ…å«çš„ä¾èµ–
#ä½¿ç”¨ -Då‚æ•°å°†ä¾èµ–æ·»åŠ åˆ°devDependenciesèŠ‚ç‚¹
npm install --save-dev eslint
#æˆ–
npm install -D eslint

#æ›´æ–°åŒ…ï¼ˆæ›´æ–°åˆ°æœ€æ–°ç‰ˆæœ¬ï¼‰
npm update åŒ…å
#å…¨å±€æ›´æ–°
npm update -g åŒ…å
#å¸è½½åŒ…
npm uninstall åŒ…å
#å…¨å±€å¸è½½
npm uninstall -g åŒ…å

```

ä¾‹å¦‚`package.json`ä¸­çš„`^3.6.4`ï¼Œä¼šè‡ªåŠ¨æ›´æ–°æœ€æ–°çš„å°ç‰ˆæœ¬ï¼Œè€Œ`package-lock.json`è¡¨ç¤ºé”å®šå½“å‰ä¾èµ–ç‰ˆæœ¬`3.6.4`ã€‚

### æ¨¡å—åŒ–å¼€å‘ï¼ˆES5ï¼‰



### æ¨¡å—åŒ–å¼€å‘ï¼ˆES6ï¼‰



#### å®‰è£…Babel

```
npm install -g babel-cli
babel --version
```

#### é…ç½®.babelrc

Babelçš„é…ç½®æ–‡ä»¶æ˜¯.babelrcï¼Œå­˜æ”¾åœ¨é¡¹ç›®çš„æ ¹ç›®å½•ä¸‹ï¼Œè¯¥æ–‡ä»¶ç”¨æ¥è®¾ç½®è½¬ç è§„åˆ™å’Œæ’ä»¶ï¼Œpresetså­—æ®µè®¾å®šè½¬ç è§„åˆ™ï¼Œå°†es2015è§„åˆ™åŠ å…¥ .babelrcï¼š

```
{
    "presets": ["es2015"],
    "plugins": []
}
```

#### å®‰è£…è½¬ç å™¨

```
npm install --save-dev babel-preset-es2015
```

#### è½¬ç 

```shell
# æ•´ä¸ªç›®å½•è½¬ç 
mkdir dist1
# --out-dir æˆ– -d å‚æ•°æŒ‡å®šè¾“å‡ºç›®å½•
babel src -d dist1
```

#### è¿è¡Œç¨‹åº 

```shell
node dist1/userComponent.js
```

### 



## å‰ç«¯æ¡†æ¶

### vue-element-admin

vue-element-adminæ˜¯åŸºäºVueå’ŒElement-ui çš„ä¸€å¥—åå°ç®¡ç†ç³»ç»Ÿé›†æˆæ–¹æ¡ˆã€‚

**åŠŸèƒ½ï¼š**https://panjiachen.github.io/vue-element-admin-site/zh/guide/

**GitHubåœ°å€ï¼š**https://github.com/PanJiaChen/vue-element-admin

### Element-ui

element-ui æ˜¯é¥¿äº†ä¹ˆå‰ç«¯å‡ºå“çš„åŸºäº Vue.jsçš„ åå°ç»„ä»¶åº“ï¼Œæ–¹ä¾¿ç¨‹åºå‘˜è¿›è¡Œé¡µé¢å¿«é€Ÿå¸ƒå±€å’Œæ„å»º

å®˜ç½‘ï¼š https://element.eleme.cn/#/zh-CN

### vue-admin-template

vue-admin-templateæ˜¯åŸºäºvue-element-adminçš„ä¸€å¥—åå°ç®¡ç†ç³»ç»ŸåŸºç¡€æ¨¡æ¿ï¼ˆ**æœ€å°‘ç²¾ç®€ç‰ˆ**ï¼‰ï¼Œå¯ä½œä¸ºæ¨¡æ¿è¿›è¡ŒäºŒæ¬¡å¼€å‘ã€‚

**GitHubåœ°å€ï¼š**https://github.com/PanJiaChen/vue-admin-template

**å»ºè®®ï¼š**ä½ å¯ä»¥åœ¨ `vue-admin-template` çš„åŸºç¡€ä¸Šè¿›è¡ŒäºŒæ¬¡å¼€å‘ï¼ŒæŠŠ `vue-element-admin`å½“åšå·¥å…·ç®±ï¼Œæƒ³è¦ä»€ä¹ˆåŠŸèƒ½æˆ–è€…ç»„ä»¶å°±å» `vue-element-admin` é‚£é‡Œå¤åˆ¶è¿‡æ¥ã€‚

vue-admin-templateæºç ç›®å½•ç»“æ„:

```
|-dist ç”Ÿäº§ç¯å¢ƒæ‰“åŒ…ç”Ÿæˆçš„æ‰“åŒ…é¡¹ç›®
|-mock äº§ç”Ÿæ¨¡æ‹Ÿæ•°æ®ï¼Œæ¨¡æ‹Ÿæ•°æ®åº“
|-public åŒ…å«ä¼šè¢«è‡ªåŠ¨æ‰“åŒ…åˆ°é¡¹ç›®æ ¹è·¯å¾„çš„æ–‡ä»¶å¤¹
	|-index.html å”¯ä¸€çš„é¡µé¢
|-src
	|-api åŒ…å«æ¥å£è¯·æ±‚å‡½æ•°æ¨¡å—
		|-table.js  è¡¨æ ¼åˆ—è¡¨mockæ•°æ®æ¥å£çš„è¯·æ±‚å‡½æ•°
		|-user.js  ç”¨æˆ·ç™»é™†ç›¸å…³mockæ•°æ®æ¥å£çš„è¯·æ±‚å‡½æ•°
	|-assets ç»„ä»¶ä¸­éœ€è¦ä½¿ç”¨çš„å…¬ç”¨èµ„æº
		|-404_images 404é¡µé¢çš„å›¾ç‰‡
	|-components éè·¯ç”±ç»„ä»¶
		|-SvgIcon svgå›¾æ ‡ç»„ä»¶
		|-Breadcrumb é¢åŒ…å±‘ç»„ä»¶(å¤´éƒ¨æ°´å¹³æ–¹å‘çš„å±‚çº§ç»„ä»¶)
		|-Hamburger ç”¨æ¥ç‚¹å‡»åˆ‡æ¢å·¦ä¾§èœå•å¯¼èˆªçš„å›¾æ ‡ç»„ä»¶
	|-icons
		|-svg åŒ…å«ä¸€äº›svgå›¾ç‰‡æ–‡ä»¶
		|-index.js å…¨å±€æ³¨å†ŒSvgIconç»„ä»¶,åŠ è½½æ‰€æœ‰svgå›¾ç‰‡å¹¶æš´éœ²æ‰€æœ‰svgæ–‡ä»¶åçš„æ•°ç»„
	|-layout
		|-components ç»„æˆæ•´ä½“å¸ƒå±€çš„ä¸€äº›å­ç»„ä»¶
		|-mixin ç»„ä»¶ä¸­å¯å¤ç”¨çš„ä»£ç 
		|-index.vue åå°ç®¡ç†çš„æ•´ä½“ç•Œé¢å¸ƒå±€ç»„ä»¶
	|-router
		|-index.js è·¯ç”±å™¨
	|-store
		|-modules
			|-app.js ç®¡ç†åº”ç”¨ç›¸å…³æ•°æ®
			|-settings.js ç®¡ç†è®¾ç½®ç›¸å…³æ•°æ®
			|-user.js ç®¡ç†åå°ç™»é™†ç”¨æˆ·ç›¸å…³æ•°æ®
		|-getters.js æä¾›å­æ¨¡å—ç›¸å…³æ•°æ®çš„gettersè®¡ç®—å±æ€§
		|-index.js vuexçš„store
	|-styles
		|-xxx.scss é¡¹ç›®ç»„ä»¶éœ€è¦ä½¿ç”¨çš„ä¸€äº›æ ·å¼(ä½¿ç”¨scss)
	|-utils ä¸€äº›å·¥å…·å‡½æ•°
		|-auth.js æ“ä½œç™»é™†ç”¨æˆ·çš„token cookie
		|-get-page-title.js å¾—åˆ°è¦æ˜¾ç¤ºçš„ç½‘é¡µtitle
		|-request.js axiosäºŒæ¬¡å°è£…çš„æ¨¡å—
		|-validate.js æ£€éªŒç›¸å…³å·¥å…·å‡½æ•°
		|-index.js æ—¥æœŸå’Œè¯·æ±‚å‚æ•°å¤„ç†ç›¸å…³å·¥å…·å‡½æ•°
	|-views è·¯ç”±ç»„ä»¶æ–‡ä»¶å¤¹
		|-dashboard é¦–é¡µ
		|-login ç™»é™†
	|-App.vue åº”ç”¨æ ¹ç»„ä»¶
	|-main.js å…¥å£js
	|-permission.js ä½¿ç”¨å…¨å±€å®ˆå«å®ç°è·¯ç”±æƒé™æ§åˆ¶çš„æ¨¡å—
	|-settings.js åŒ…å«åº”ç”¨è®¾ç½®ä¿¡æ¯çš„æ¨¡å—
|-tests  æµ‹è¯•æ–‡ä»¶ç›®å½•
|-.env.development æŒ‡å®šäº†å¼€å‘ç¯å¢ƒçš„ä»£ç†æœåŠ¡å™¨å‰ç¼€è·¯å¾„
|-.env.production æŒ‡å®šäº†ç”Ÿäº§ç¯å¢ƒçš„ä»£ç†æœåŠ¡å™¨å‰ç¼€è·¯å¾„
|-.eslintignore eslintçš„å¿½ç•¥é…ç½®
|-.eslintrc.js eslintçš„æ£€æŸ¥é…ç½®
|-.gitignore gitçš„å¿½ç•¥é…ç½®
|-.npmrc æŒ‡å®šnpmçš„æ·˜å®é•œåƒå’Œsassçš„ä¸‹è½½åœ°å€
|-babel.config.js babelçš„é…ç½®
|-jsconfig.json ç”¨äºvscodeå¼•å…¥è·¯å¾„æç¤ºçš„é…ç½®
|-package.json å½“å‰é¡¹ç›®åŒ…ä¿¡æ¯
|-package-lock.json å½“å‰é¡¹ç›®ä¾èµ–çš„ç¬¬ä¸‰æ–¹åŒ…çš„ç²¾ç¡®ä¿¡æ¯
|-vue.config.js webpackç›¸å…³é…ç½®(å¦‚: ä»£ç†æœåŠ¡å™¨)
```



### æ­å»ºé¡¹ç›®å‰ç«¯ç¯å¢ƒ

1. ç›´æ¥ä¸‹è½½vue-admin-templateï¼Œä¿®æ”¹æ–‡ä»¶åç„¶åæ‹·è´åˆ°è‡ªå·±é¡¹ç›®ä¸­
2. `npm install`
3. å¯åŠ¨é¡¹ç›®`npm run dev`



##### æ”¹é€ æ¡†æ¶ç™»å½•åŠŸèƒ½

1. æŠŠ`vue.config.js`ä¸­çš„

```vue
before: require('./mock/mock-server.js')
```

æ”¹æˆï¼š

```javascript
proxy: {
  '/dev-api': { // åŒ¹é…æ‰€æœ‰ä»¥ '/dev-api'å¼€å¤´çš„è¯·æ±‚è·¯å¾„
    target: 'http://localhost:8800',
      changeOrigin: true, // æ”¯æŒè·¨åŸŸ
        pathRewrite: { // é‡å†™è·¯å¾„: å»æ‰è·¯å¾„ä¸­å¼€å¤´çš„'/dev-api'
          '^/dev-api': ''
        }
  }
}
```



![](images/image-20230328174851454.png)

è·¨åŸŸé—®é¢˜æ˜¯æµè§ˆå™¨å¯¹ajaxè¯·æ±‚çš„ä¸€ç§é™åˆ¶ã€‚

2. ä¿®æ”¹`src/utils/request.js`æ–‡ä»¶

`src/utils/request.js`ä¸­å¯¹axiosåšäº†å°è£…ï¼Œæœ‰requestå’Œresponseçš„æ‹¦æˆªå™¨ï¼ˆæ¯ä¸€æ¬¡è¯·æ±‚å’Œå›å¤æ—¶éƒ½è¦å…ˆæ‰§è¡Œè¿™é‡Œçš„ä»£ç ï¼‰ã€‚

æŠŠè¯·æ±‚çŠ¶æ€ç ç»™æˆå’Œåç«¯ä¸€æ ·çš„200ã€‚

3. `src/api/user.js`ä¿®æ”¹ç™»å½•ç»“æ„è·¯å¾„å’Œæäº¤æ–¹å¼ï¼ˆä¸åç«¯ä¸€è‡´ï¼‰ã€‚



é€€å‡ºå¯ä»¥åç«¯å†™ä¸€ä¸ªæ¥å£ï¼Œä¹Ÿå¯æ˜¯å‰ç«¯ç›´æ¥æ¸…ç©ºcookieå³å¯ï¼ˆ`src/store/modules/user.js`ï¼‰ï¼š

```javascript
  // user logout é€€å‡ºæš‚æ—¶ä¸è°ƒç”¨åç«¯æ¥å£ï¼Œç›´æ¥å‰ç«¯æ¸…ç©ºcookieå³å¯ï¼Œ
  logout({ commit, state }) {
    return new Promise((resolve, reject) => {
      // logout(state.token).then(() => {
        removeToken() // must remove  token  first
        resetRouter()
        commit('RESET_STATE')
        resolve()
      // }).catch(error => {
      //   reject(error)
      // })
    })
  },
```



## è§’è‰²ç®¡ç†å‰ç«¯



### è§’è‰²åˆ—è¡¨

1. æ·»åŠ è§’è‰²ç®¡ç†è·¯ç”± `router/index.js`



2. åˆ›å»ºè·¯ç”±å¯¹åº”é¡µé¢ `system/sysRole/list.vue`





3. åœ¨apiç›®å½•åˆ›å»ºjsæ–‡ä»¶ï¼Œå®šä¹‰è§’è‰²ç®¡ç†æ¥å£ `src/api/system/sysRole.js`





4. åœ¨å…·ä½“åŠŸèƒ½é¡µé¢è°ƒç”¨apiå®šä¹‰çš„æ–¹æ³•è·å–æ¥å£è¿”å›æ•°æ®(åˆå§‹åŒ–vueç»„ä»¶)

src/views/system/sysRole/list.vue

```vue
<template>
    <div class="app-container">
        è§’è‰²åˆ—è¡¨
    </div>
</template>

<script>
import api from '@/api/system/sysRole'

export default {
    data() {
        return {

        }
    },
    created() {
        this.fetchData()
    },
    methods: {
        fetchData() {

        }
    }
}
</script>
```





5. æŠŠæ¥å£è¿”å›æ•°æ®è¿›è¡Œå¤„ç†ï¼Œä½¿ç”¨Element-uiæ˜¾ç¤º

å®šä¹‰data

```js
  // å®šä¹‰æ•°æ®æ¨¡å‹
  data() {
    return {
      listLoading:true, // æ•°æ®æ˜¯å¦æ­£åœ¨åŠ è½½
      list: [], // è§’è‰²åˆ—è¡¨
      total: 0, // æ€»è®°å½•æ•°
      page: 1, // é¡µç 
      limit: 2, // æ¯é¡µè®°å½•æ•°
      searchObj: {}, // æŸ¥è¯¢æ¡ä»¶
    }
  },
```

å®šä¹‰methods

```js
 methods: {
    fetchData(pageNum=1) {
       this.page = pageNum
      // è°ƒç”¨api
      api.getPageList(this.page, this.limit, this.searchObj).then(response => {
        debugger
        this.listLoading = false
        this.list = response.data.records
        this.total = response.data.total
      })
    },
  }
```

è¡¨æ ¼æ¸²æŸ“

```vue
<div class="app-container">
    <!-- è¡¨æ ¼ -->
    <el-table
      v-loading="listLoading"
      :data="list"
      stripe
      border
      style="width: 100%;margin-top: 10px;">

      <el-table-column
        label="åºå·"
        width="70"
        align="center">
        <template slot-scope="scope">
          {{ (page - 1) * limit + scope.$index + 1 }}
        </template>
      </el-table-column>

      <el-table-column prop="roleName" label="è§’è‰²åç§°" />
      <el-table-column prop="roleCode" label="è§’è‰²ç¼–ç " />
      <el-table-column prop="createTime" label="åˆ›å»ºæ—¶é—´" width="160"/>
      <el-table-column label="æ“ä½œ" width="200" align="center">
        <template slot-scope="scope">
          <el-button type="primary" icon="el-icon-edit" size="mini" @click="edit(scope.row.id)" title="ä¿®æ”¹"/>
          <el-button type="danger" icon="el-icon-delete" size="mini" @click="removeDataById(scope.row.id)" title="åˆ é™¤"/>
        </template>
      </el-table-column>
    </el-table>
  </div>
```

åˆ†é¡µç»„ä»¶

```vue
  <!-- åˆ†é¡µç»„ä»¶ -->
  <el-pagination
    :current-page="page"
    :total="total"
    :page-size="limit"
    style="padding: 30px 0; text-align: center;"
    layout="total, prev, pager, next, jumper"
    @current-change="fetchData"
  />
```

é¡¶éƒ¨æŸ¥è¯¢è¡¨å•

```vue
<!--æŸ¥è¯¢è¡¨å•-->
<div class="search-div">
      <el-form label-width="70px" size="small">
        <el-row>
          <el-col :span="24">
            <el-form-item label="è§’è‰²åç§°">
              <el-input style="width: 100%" v-model="searchObj.roleName" placeholder="è§’è‰²åç§°"></el-input>
            </el-form-item>
          </el-col>
        </el-row>
        <el-row style="display:flex">
          <el-button type="primary" icon="el-icon-search" size="mini"  @click="fetchData()">æœç´¢</el-button>
          <el-button icon="el-icon-refresh" size="mini" @click="resetData">é‡ç½®</el-button>
        </el-row>
      </el-form>
    </div>
```

**é‡ç½®è¡¨å•æ–¹æ³•**

```js
// é‡ç½®è¡¨å•
resetData() {
    console.log('é‡ç½®æŸ¥è¯¢è¡¨å•')
    this.searchObj = {}
    this.fetchData()
}
```



### è§’è‰²åˆ é™¤



> p50ï¼ŒğŸ
>
> JavaScript èƒ½è¡¨ç¤ºå¹¶è¿›è¡Œç²¾ç¡®ç®—æœ¯è¿ç®—çš„æ•´æ•°èŒƒå›´ä¸ºï¼š**æ­£è´Ÿ2 çš„53 æ¬¡æ–¹ï¼Œä¹Ÿå³ä»æœ€å°å€¼-9007199254740992 åˆ°æœ€å¤§å€¼+9007199254740992 ä¹‹é—´çš„èŒƒå›´**ã€‚è¿™æ˜¯16ä½çš„ã€‚
>
> è€Œåç«¯mpè‡ªåŠ¨ç”Ÿæˆçš„idæ˜¯19ä½çš„ï¼ˆ2çš„63æ¬¡æ–¹ï¼‰

### è§’è‰²æ·»åŠ 



### è§’è‰²ä¿®æ”¹ä¸æ•°æ®å›æ˜¾



### æ‰¹é‡åˆ é™¤





## ç”¨æˆ·ç®¡ç†

### CRUD



### ç”¨æˆ·ç®¡ç†å‰ç«¯å®ç°



### æ›´æ”¹ç”¨æˆ·çŠ¶æ€



### å‰ç«¯å®ç°



### ç»™ç”¨æˆ·åˆ†é…è§’è‰²



ğŸå¯ä»¥è¿è¡Œï¼Œä½†çº¢çº¿ 

```
v-model="scope.row.status === 1"
```



## èœå•ç®¡ç†

### èœå•ç®¡ç†éœ€æ±‚

ä¸åŒè§’è‰²çš„ç”¨æˆ·ç™»å½•åå°ç®¡ç†ç³»ç»Ÿæ‹¥æœ‰ä¸åŒçš„èœå•æƒé™ä¸åŠŸèƒ½æƒé™ã€‚æˆ‘ä»¬å‰ç«¯æ˜¯åŸºäºï¼švue-admin-templateè¿™ä¸ªæ¨¡å—å¼€å‘çš„ï¼Œå› æ­¤æˆ‘ä»¬èœå•è¡¨è®¾è®¡ä¹Ÿå¿…é¡»åŸºäºå‰ç«¯æ¨¡æ¿è¿›è¡Œè®¾è®¡ã€‚

å‰ç«¯æ¡†æ¶vue-admin-templateèœå•å…¶å®å°±æ˜¯æˆ‘ä»¬é…ç½®çš„è·¯ç”±ï¼š

```js
{
  path: '/system',
  component: Layout,
  meta: {
    title: 'ç³»ç»Ÿç®¡ç†',
    icon: 'el-icon-s-tools'
  },
  alwaysShow: true,
  children: [
    {
      name: 'sysUser',
      path: 'sysUser',
      component: () => import('@/views/system/sysUser/list'),
      meta: {
        title: 'ç”¨æˆ·ç®¡ç†',
        icon: 'el-icon-s-custom'
      },
    },
    {
      path: 'sysRole',
      component: () => import('@/views/system/sysRole/list'),
      meta: {
        title: 'è§’è‰²ç®¡ç†',
        icon: 'el-icon-s-help'
      },
    },
    {
      name: 'sysMenu',
      path: 'sysMenu',
      component: () => import('@/views/system/sysMenu/list'),
      meta: {
        title: 'èœå•ç®¡ç†',
        icon: 'el-icon-s-unfold'
      },
    },
    {
      path: 'assignAuth',
      component: () => import('@/views/system/sysRole/assignAuth'),
      meta: {
        activeMenu: '/system/sysRole',
        title: 'è§’è‰²æˆæƒ'
      },
      hidden: true,
    }
  ]
}
```

å› æ­¤ï¼Œèœå•è¡¨çš„è®¾è®¡å¿…é¡»æ»¡è¶³è·¯ç”±é…ç½®çš„å¿…è¦ä¿¡æ¯ã€‚

### èœå•è¡¨è®¾è®¡

```mysql
CREATE TABLE `sys_menu` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ç¼–å·',
  `parent_id` bigint NOT NULL DEFAULT '0' COMMENT 'æ‰€å±ä¸Šçº§',
  `name` varchar(20) NOT NULL DEFAULT '' COMMENT 'åç§°',
  `type` tinyint NOT NULL DEFAULT '0' COMMENT 'ç±»å‹(0:ç›®å½•,1:èœå•,2:æŒ‰é’®)',
  `path` varchar(100) DEFAULT NULL COMMENT 'è·¯ç”±åœ°å€',
  `component` varchar(100) DEFAULT NULL COMMENT 'ç»„ä»¶è·¯å¾„',
  `perms` varchar(100) DEFAULT NULL COMMENT 'æƒé™æ ‡è¯†',
  `icon` varchar(100) DEFAULT NULL COMMENT 'å›¾æ ‡',
  `sort_value` int DEFAULT NULL COMMENT 'æ’åº',
  `status` tinyint DEFAULT NULL COMMENT 'çŠ¶æ€(0:ç¦æ­¢,1:æ­£å¸¸)',
  `create_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'åˆ›å»ºæ—¶é—´',
  `update_time` timestamp NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'æ›´æ–°æ—¶é—´',
  `is_deleted` tinyint NOT NULL DEFAULT '0' COMMENT 'åˆ é™¤æ ‡è®°ï¼ˆ0:å¯ç”¨ 1:å·²åˆ é™¤ï¼‰',
  PRIMARY KEY (`id`),
  KEY `idx_parent_id` (`parent_id`)
) ENGINE=InnoDB AUTO_INCREMENT=35 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci COMMENT='èœå•è¡¨';
```

é‡ç‚¹å­—æ®µè¯´æ˜ï¼š

â€‹	typeï¼šèœå•ç±»å‹ï¼Œåˆ†ä¸ºï¼šç›®å½•ã€èœå•ä¸æŒ‰é’®

â€‹				ç›®å½•ï¼šä¸€ä¸ªåˆ†ç±»ï¼ˆå¯ç†è§£ä¸ºä¸€çº§èœå•ï¼‰ã€ç›®å½•ä¸‹çº§èŠ‚ç‚¹å¯ä»¥ä¸ºç›®å½•ä¸èœå•

â€‹				èœå•ï¼šä¸€ä¸ªå…·ä½“é¡µé¢ï¼Œèœå•çš„ä¸‹çº§èŠ‚ç‚¹åªèƒ½æ˜¯æŒ‰é’®

â€‹				æŒ‰é’®ï¼šé¡µé¢ä¸Šçš„åŠŸèƒ½

â€‹	pathï¼šå¯¹åº”è·¯ç”±é‡Œé¢çš„è·¯ç”±åœ°å€path

â€‹	componentï¼šå¯¹åº”è·¯ç”±é‡Œé¢çš„ç»„ä»¶component

â€‹	permsï¼šå¯¹åº”èœå•çš„åŠŸèƒ½æƒé™æ ‡è¯†

â€‹	icomï¼šå¯¹åº”è·¯ç”±çš„èœå•å›¾æ ‡

### CRUD



### èœå•ç®¡ç†å‰ç«¯



### ç»™è§’è‰²åˆ†é…æƒé™



![](images/image-20230329132542722.png)

![](images/image-20230329132800918.png)

1ã€è¿›å…¥åˆ†é…é¡µé¢ï¼šè·å–å…¨éƒ¨èœå•åŠæŒ‰é’®ï¼Œé€‰ä¸­å·²é€‰å¤é€‰æ¡†ï¼Œè¿›è¡Œé¡µé¢å±•ç¤º

2ã€ä¿å­˜åˆ†é…æƒé™ï¼šåˆ é™¤ä¹‹å‰åˆ†é…çš„æƒé™å’Œä¿å­˜ç°åœ¨åˆ†é…çš„æƒé™

## æƒé™ç®¡ç†

### 1 æƒé™ç®¡ç†ä»‹ç»

æ¯ä¸ªç³»ç»Ÿçš„æƒé™åŠŸèƒ½éƒ½ä¸å°½ç›¸åŒï¼Œå„æœ‰å…¶è‡ªèº«çš„ä¸šåŠ¡ç‰¹ç‚¹ï¼Œå¯¹æƒé™ç®¡ç†çš„è®¾è®¡ä¹Ÿéƒ½å„æœ‰ç‰¹è‰²ã€‚ä¸è¿‡ä¸ç®¡æ˜¯æ€æ ·çš„æƒé™è®¾è®¡ï¼Œå¤§è‡´å¯å½’ä¸ºä¸‰ç§ï¼š**é¡µé¢æƒé™(èœå•çº§)ã€æ“ä½œæƒé™ï¼ˆæŒ‰é’®çº§ï¼‰ã€æ•°æ®æƒé™**ã€‚å½“å‰ç³»ç»Ÿåªæ˜¯è®²è§£ï¼šèœå•æƒé™ä¸æŒ‰é’®æƒé™çš„æ§åˆ¶ã€‚

#### èœå•æƒé™

èœå•æƒé™å°±æ˜¯å¯¹é¡µé¢çš„æ§åˆ¶ï¼Œå°±æ˜¯æœ‰è¿™ä¸ªæƒé™çš„ç”¨æˆ·æ‰èƒ½è®¿é—®è¿™ä¸ªé¡µé¢ï¼Œæ²¡è¿™ä¸ªæƒé™çš„ç”¨æˆ·å°±æ— æ³•è®¿é—®ï¼Œå®ƒæ˜¯ä»¥æ•´ä¸ªé¡µé¢ä¸ºç»´åº¦ï¼Œå¯¹æƒé™çš„æ§åˆ¶å¹¶æ²¡æœ‰é‚£ä¹ˆç»†ï¼Œæ‰€ä»¥æ˜¯ä¸€ç§**ç²—é¢—ç²’æƒé™**ã€‚

#### æŒ‰é’®æƒé™

æŒ‰é’®æƒé™å°±æ˜¯å°†é¡µé¢çš„**æ“ä½œ**è§†ä¸ºèµ„æºï¼Œæ¯”å¦‚åˆ é™¤æ“ä½œï¼Œæœ‰äº›äººå¯ä»¥æ“ä½œæœ‰äº›äººä¸èƒ½æ“ä½œã€‚å¯¹äºåç«¯æ¥è¯´ï¼Œæ“ä½œå°±æ˜¯ä¸€ä¸ªæ¥å£ã€‚äºå‰ç«¯æ¥è¯´ï¼Œæ“ä½œå¾€å¾€æ˜¯ä¸€ä¸ªæŒ‰é’®ï¼Œæ˜¯ä¸€ç§**ç»†é¢—ç²’æƒé™**ã€‚

#### æƒé™ç®¡ç†è®¾è®¡æ€è·¯

å‰é¢æˆ‘ä»¬è®²è§£äº†ç”¨æˆ·ç®¡ç†ã€è§’è‰²ç®¡ç†åŠèœå•ç®¡ç†ï¼Œæˆ‘ä»¬æŠŠèœå•æƒé™åˆ†é…ç»™è§’è‰²ï¼ŒæŠŠè§’è‰²åˆ†é…ç»™ç”¨æˆ·ï¼Œé‚£ä¹ˆç”¨æˆ·å°±æ‹¥æœ‰äº†è§’è‰²çš„æ‰€æœ‰æƒé™ï¼ˆæƒé™åŒ…å«ï¼šèœå•æƒé™ä¸æŒ‰é’®æƒé™ï¼‰ã€‚

å…ˆéœ€è¦å®ç°è¿™ä¸¤ä¸ªæ¥å£ï¼š

1ã€ç”¨æˆ·ç™»å½•

2ã€ç™»å½•æˆåŠŸæ ¹æ®tokenè·å–ç”¨æˆ·ç›¸å…³ä¿¡æ¯ï¼ˆèœå•æƒé™åŠæŒ‰é’®æƒé™æ•°æ®ç­‰ï¼‰

è¯¦ç»†

1ã€ç”¨æˆ·ç™»å½•ï¼Œç™»å½•æˆåŠŸä¹‹åï¼Œ**ä¿æŒç”¨æˆ·çŠ¶æ€**ï¼Œè·å–**å½“å‰ç™»å½•ç”¨æˆ·èœå•å’ŒæŒ‰é’®æ“ä½œæƒé™**

ç¬¬ä¸€ç§æ–¹å¼ï¼šSessionï¼ˆ`HttpSession`ï¼‰ï¼Œç¼ºé™·ï¼šåˆ†å¸ƒå¼éƒ¨ç½²æ—¶ï¼Œsessionæ— æ³•å®ç°å…±äº«

ç¬¬äºŒç§æ–¹å¼ï¼štoken

tokenæ˜¯æŒ‰ç…§==çº¦å®šè§„åˆ™==ç”Ÿæˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¸²å†è¿›è¡Œç¼–ç åŠ å¯†å¤„ç†

> tokenå¦‚ä½•å…±äº«ï¼Ÿ
>
> - æ¯æ¬¡ç™»å½•æˆåŠŸä¹‹åï¼Œè¿”å›ç”Ÿæˆtokenå­—ç¬¦ä¸²
> - å‰ç«¯æŠŠè¿”å›çš„tokenæ”¾åˆ°cookieé‡Œé¢ï¼ˆcookieä¸èƒ½è·¨åŸŸä¼ é€’ï¼‰
> - æ¯æ¬¡å‘é€è¯·æ±‚æºå¸¦è¿™ä¸ªtokenå‘é€ï¼ˆæŠŠtokenå€¼æ”¾åˆ°è¯·æ±‚å¤´ï¼‰

tokenç”Ÿæˆå¯ä»¥å®‰è£…è‡ªå·±çº¦å®šè§„åˆ™ï¼Œä½†ä¸€èˆ¬å¯ä»¥ä½¿ç”¨ç”Ÿæˆå·¥å…·JWTã€‚

### 2 JWT

JWTæ˜¯JSON Web Tokençš„ç¼©å†™ï¼Œå³JSON Webä»¤ç‰Œï¼Œæ˜¯ä¸€ç§**è‡ªåŒ…å«ä»¤ç‰Œ**ã€‚ æ˜¯ä¸ºäº†åœ¨ç½‘ç»œåº”ç”¨ç¯å¢ƒé—´ä¼ é€’å£°æ˜è€Œæ‰§è¡Œçš„ä¸€ç§åŸºäºJSONçš„å¼€æ”¾æ ‡å‡†ã€‚

JWTçš„å£°æ˜ä¸€èˆ¬è¢«ç”¨æ¥åœ¨èº«ä»½æä¾›è€…å’ŒæœåŠ¡æä¾›è€…é—´ä¼ é€’è¢«è®¤è¯çš„ç”¨æˆ·èº«ä»½ä¿¡æ¯ï¼Œä»¥ä¾¿äºä»èµ„æºæœåŠ¡å™¨è·å–èµ„æºã€‚æ¯”å¦‚ç”¨åœ¨ç”¨æˆ·ç™»å½•ä¸Šã€‚

JWTæœ€é‡è¦çš„ä½œç”¨å°±æ˜¯å¯¹ tokenä¿¡æ¯çš„**é˜²ä¼ªä½œç”¨**ã€‚

#### JWTä»¤ç‰Œçš„ç»„æˆ

ä¸€ä¸ªJWTç”±ä¸‰ä¸ªéƒ¨åˆ†ç»„æˆï¼š**JWTå¤´ã€æœ‰æ•ˆè½½è·ã€ç­¾åå“ˆå¸Œ**
æœ€åç”±è¿™ä¸‰è€…ç»„åˆè¿›è¡Œbase64urlç¼–ç å¾—åˆ°JWT

å…¸å‹çš„ï¼Œä¸€ä¸ªJWTçœ‹èµ·æ¥å¦‚ä¸‹å›¾ï¼šè¯¥å¯¹è±¡ä¸ºä¸€ä¸ªå¾ˆé•¿çš„å­—ç¬¦ä¸²ï¼Œå­—ç¬¦ä¹‹é—´é€šè¿‡"."åˆ†éš”ç¬¦åˆ†ä¸ºä¸‰ä¸ªå­ä¸²ã€‚
https://jwt.io/

![](images/image-20230329140039257.png)

**JWTå¤´**

JWTå¤´éƒ¨åˆ†æ˜¯ä¸€ä¸ªæè¿°JWTå…ƒæ•°æ®çš„JSONå¯¹è±¡ï¼Œé€šå¸¸å¦‚ä¸‹æ‰€ç¤ºã€‚

```json
{
  "alg": "HS256",
  "typ": "JWT"
}
```

åœ¨ä¸Šé¢çš„ä»£ç ä¸­ï¼Œalgå±æ€§è¡¨ç¤ºç­¾åä½¿ç”¨çš„ç®—æ³•ï¼Œé»˜è®¤ä¸ºHMAC SHA256ï¼ˆå†™ä¸ºHS256ï¼‰ï¼›

typå±æ€§è¡¨ç¤ºä»¤ç‰Œçš„ç±»å‹ï¼ŒJWTä»¤ç‰Œç»Ÿä¸€å†™ä¸ºJWTã€‚

æœ€åï¼Œä½¿ç”¨Base64 URLç®—æ³•å°†ä¸Šè¿°JSONå¯¹è±¡è½¬æ¢ä¸ºå­—ç¬¦ä¸²ä¿å­˜ã€‚



**æœ‰æ•ˆè½½è·**

æœ‰æ•ˆè½½è·éƒ¨åˆ†ï¼Œæ˜¯JWTçš„ä¸»ä½“å†…å®¹éƒ¨åˆ†ï¼Œä¹Ÿæ˜¯ä¸€ä¸ªJSONå¯¹è±¡ï¼ŒåŒ…å«éœ€è¦ä¼ é€’çš„æ•°æ®ã€‚ JWTæŒ‡å®šä¸ƒä¸ªé»˜è®¤å­—æ®µä¾›é€‰æ‹©ã€‚

```json
iss: jwtç­¾å‘è€…
sub: ä¸»é¢˜
aud: æ¥æ”¶jwtçš„ä¸€æ–¹
exp: jwtçš„è¿‡æœŸæ—¶é—´ï¼Œè¿™ä¸ªè¿‡æœŸæ—¶é—´å¿…é¡»è¦å¤§äºç­¾å‘æ—¶é—´
nbf: å®šä¹‰åœ¨ä»€ä¹ˆæ—¶é—´ä¹‹å‰ï¼Œè¯¥jwtéƒ½æ˜¯ä¸å¯ç”¨çš„.
iat: jwtçš„ç­¾å‘æ—¶é—´
jti: jwtçš„å”¯ä¸€èº«ä»½æ ‡è¯†ï¼Œä¸»è¦ç”¨æ¥ä½œä¸ºä¸€æ¬¡æ€§token,ä»è€Œå›é¿é‡æ”¾æ”»å‡»ã€‚
```

é™¤ä»¥ä¸Šé»˜è®¤å­—æ®µå¤–ï¼Œæˆ‘ä»¬è¿˜å¯ä»¥è‡ªå®šä¹‰ç§æœ‰å­—æ®µï¼Œå¦‚ä¸‹ä¾‹ï¼š

```json
{
  "name": "Helen",
  "role": "editor",
  "avatar": "helen.jpg"
}
```

è¯·æ³¨æ„ï¼Œé»˜è®¤æƒ…å†µä¸‹JWTæ˜¯æœªåŠ å¯†çš„ï¼Œä»»ä½•äººéƒ½å¯ä»¥è§£è¯»å…¶å†…å®¹ï¼Œå› æ­¤ä¸è¦æ„å»ºéšç§ä¿¡æ¯å­—æ®µï¼Œå­˜æ”¾ä¿å¯†ä¿¡æ¯ï¼Œä»¥é˜²æ­¢ä¿¡æ¯æ³„éœ²ã€‚

JSONå¯¹è±¡ä¹Ÿä½¿ç”¨Base64 URLç®—æ³•è½¬æ¢ä¸ºå­—ç¬¦ä¸²ä¿å­˜ã€‚



**ç­¾åå“ˆå¸Œ**

ç­¾åå“ˆå¸Œéƒ¨åˆ†æ˜¯å¯¹ä¸Šé¢ä¸¤éƒ¨åˆ†æ•°æ®ç­¾åï¼Œé€šè¿‡æŒ‡å®šçš„ç®—æ³•ç”Ÿæˆå“ˆå¸Œï¼Œä»¥ç¡®ä¿æ•°æ®ä¸ä¼šè¢«ç¯¡æ”¹ã€‚

é¦–å…ˆï¼Œéœ€è¦æŒ‡å®šä¸€ä¸ªå¯†ç ï¼ˆsecretï¼‰ã€‚è¯¥å¯†ç ä»…ä»…ä¸ºä¿å­˜åœ¨æœåŠ¡å™¨ä¸­ï¼Œå¹¶ä¸”ä¸èƒ½å‘ç”¨æˆ·å…¬å¼€ã€‚ç„¶åï¼Œä½¿ç”¨æ ‡å¤´ä¸­æŒ‡å®šçš„ç­¾åç®—æ³•ï¼ˆé»˜è®¤æƒ…å†µä¸‹ä¸ºHMAC SHA256ï¼‰æ ¹æ®ä»¥ä¸‹å…¬å¼ç”Ÿæˆç­¾åã€‚

```
HMACSHA256(base64UrlEncode(header) + "." + base64UrlEncode(claims), secret)    ==>   ç­¾åhash
```

åœ¨è®¡ç®—å‡ºç­¾åå“ˆå¸Œåï¼ŒJWTå¤´ï¼Œæœ‰æ•ˆè½½è·å’Œç­¾åå“ˆå¸Œçš„ä¸‰ä¸ªéƒ¨åˆ†ç»„åˆæˆä¸€ä¸ªå­—ç¬¦ä¸²ï¼Œæ¯ä¸ªéƒ¨åˆ†ç”¨"."åˆ†éš”ï¼Œå°±æ„æˆæ•´ä¸ªJWTå¯¹è±¡ã€‚



**Base64URLç®—æ³•**

å¦‚å‰æ‰€è¿°ï¼ŒJWTå¤´å’Œæœ‰æ•ˆè½½è·åºåˆ—åŒ–çš„ç®—æ³•éƒ½ç”¨åˆ°äº†Base64URLã€‚è¯¥ç®—æ³•å’Œå¸¸è§Base64ç®—æ³•ç±»ä¼¼ï¼Œç¨æœ‰å·®åˆ«ã€‚

ä½œä¸ºä»¤ç‰Œçš„JWTå¯ä»¥æ”¾åœ¨URLä¸­ï¼ˆä¾‹å¦‚api.example/?token=xxxï¼‰ã€‚ Base64ä¸­ç”¨çš„ä¸‰ä¸ªå­—ç¬¦æ˜¯"+"ï¼Œ"/"å’Œ"="ï¼Œç”±äºåœ¨URLä¸­æœ‰ç‰¹æ®Šå«ä¹‰ï¼Œå› æ­¤Base64URLä¸­å¯¹ä»–ä»¬åšäº†æ›¿æ¢ï¼š"="å»æ‰ï¼Œ"+"ç”¨"-"æ›¿æ¢ï¼Œ"/"ç”¨"_"æ›¿æ¢ï¼Œè¿™å°±æ˜¯Base64URLç®—æ³•ã€‚

#### é¡¹ç›®ä¸­é›†æˆJWT

common-util

```xml
<dependency>
  <groupId>io.jsonwebtoken</groupId>
  <artifactId>jjwt</artifactId>
</dependency>
```

æ·»åŠ JWTå¸®åŠ©ç±»



### 3 ç”¨æˆ·ç™»å½•



### 4 è·å–ç”¨æˆ·ä¿¡æ¯



### 5 å‰ç«¯å¯¹æ¥

- `src/utils/request.js`ä¸­ä¿®æ”¹ï¼š

```js
service.interceptors.request.use(
  config => {
    if (store.getters.token) {
      // config.headers['X-Token'] = getToken()
      config.headers['token'] = getToken()
    }
    return config
  },
)
```

- `src/store/modules/user.js`ï¼Œæ–°å¢èœå•å’ŒæŒ‰é’®å¤„ç†

```js
const getDefaultState = () => {
  return {
    token: getToken(),
    name: '',
    avatar: '',

    buttons: [],
    menus: ''
  }
}


const mutations = {
// ...

  SET_BUTTONS: (state, buttons) => {
    state.buttons = buttons
  },
  SET_MENUS: (state, menus) => {
    state.menus = menus
  }
}


  // get user info
  getInfo({ commit, state }) {
    return new Promise((resolve, reject) => {
      getInfo(state.token).then(response => {
        // ...

        commit("SET_BUTTONS", data.buttons)
        commit("SET_MENUS", data.routers)

        resolve(data)
      }).catch(error => {
        reject(error)
      })
    })
  },
```

- `src/store/getters.js` ä¸­æ–°å¢èœå•å’ŒæŒ‰é’®å¤„ç†

```js
const getters = {
// ...

  bottons: state => state.user.buttons,
  menus: state => state.user.menus
}
export default getters

```

- `src/router` æ–°å»ºä¸¤ä¸ªjsæ–‡ä»¶

_import_development.js

_import_production.js

- ä¿®æ”¹ `system-front/src/permission.js`



- åˆ é™¤`src/router/index.js`ä¸­è‡ªå®šä¹‰çš„è·¯ç”±



- åœ¨`src/components`æ–°å»ºParentViewæ–‡ä»¶å¤¹ï¼Œæ·»åŠ index.vue

```vue
<template >
  <router-view />
</template>
```

è·¯ç”±åœ¨è¿™ä¸ªé¡µé¢æ˜¾ç¤º

- ä¿®æ”¹`system-front/src/layout/components/Sidebar/index.vue`

```vue
export default {
  computed: {
    routes() {
      // return this.$router.options.routes
      return this.$router.options.routes.concat(global.antRouter)
    },
```

- æ–°å»ºæ–‡ä»¶`system-front/src/utils/btn-permission.js`

```js
import store from '@/store'

/**
 * åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰æ­¤æŒ‰é’®æƒé™
 * æŒ‰é’®æƒé™å­—ç¬¦ä¸² permission 
 */
export default function hasBtnPermission(permission) {
  // å¾—åˆ°å½“å‰ç”¨æˆ·çš„æ‰€æœ‰æŒ‰é’®æƒé™
  const myBtns = store.getters.buttons
  // å¦‚æœæŒ‡å®šçš„åŠŸèƒ½æƒé™åœ¨myBtnsä¸­, è¿”å›true ==> è¿™ä¸ªæŒ‰é’®å°±ä¼šæ˜¾ç¤º, å¦åˆ™éšè—
  return myBtns.indexOf(permission) !== -1
}
```



- åœ¨ç¨‹åºå…¥å£æ–‡ä»¶`system-front/src/main.js`ä¸­æ·»åŠ 

```js
import hasBtnPermission from './utils/btn-permission'
Vue.prototype.$hasBP = hasBtnPermission
```



- æŒ‰é’®æƒé™æ§åˆ¶

`$hasBP('bnt.sysRole.add')` æ§åˆ¶æŒ‰é’®æ˜¯å¦æ˜¾ç¤ºã€‚

å¦‚ï¼šè§’è‰²ç®¡ç†æ·»åŠ æŒ‰é’®ï¼Œæˆ‘ä»¬æ²¡è®©æŒ‰é’®éšè—ï¼Œè€Œæ˜¯è®©æŒ‰é’®ä¸å¯æ“ä½œ

```vue
<el-button type="success" icon="el-icon-plus" size="mini" @click="add" :disabled="$hasBP('bnt.sysRole.add')  === false">æ·» åŠ </el-button>
```



### æƒé™æµ‹è¯•æ–¹å¼

> 1 ä½¿ç”¨è¶…çº§ç®¡ç†å‘˜ç™»å½•
>
> â€‹	åˆ›å»ºæ–°ç”¨æˆ·
>
> â€‹	ä¸ºæ–°ç”¨æˆ·åˆ†é…è§’è‰²ï¼ˆæ–°å»ºè§’è‰²ï¼‰
>
> â€‹	ä¸ºè§’è‰²åˆ†é…èœå•å’ŒæŒ‰é’®æƒé™
>
> 2 ä½¿ç”¨æ–°åˆ›å»ºç”¨æˆ·è¿›è¡Œç™»å½•
>
> â€‹	è¿›è¡ŒæŸ¥çœ‹



æµ‹è¯•ä¹‹å‰ä¿®æ”¹å‰ç«¯ä»£ç ï¼š

1 åœ¨å‰ç«¯æŒ‰é’®ä¸Šæ·»åŠ æ·»åŠ åˆ¤æ–­ï¼Œç±»ä¼¼ï¼š

```js
<el-button type="success" :disabled="$hasBP('bnt.sysUser.add')" icon="el-icon-plus" size="mini" @click="add">æ·» åŠ </el-button>
```

2 ä¿®æ”¹ç™»å½•é¡µé¢è‡ªå¸¦æ ¡éªŒ



### æ€»ç»“

å½“å‰æˆ‘ä»¬å·²ç»å®ç°å‰ç«¯èœå•åŠæŒ‰é’®çš„æƒé™æ§åˆ¶ï¼ŒæœåŠ¡å™¨ç«¯è¿˜æ²¡åŠ ä»»ä½•æ§åˆ¶ï¼Œé‚£ä¹ˆæœåŠ¡å™¨ç«¯æ€ä¹ˆæ§åˆ¶å‘¢ï¼Ÿå…¶å®å¾ˆç®€å•ï¼Œå°±æ˜¯è¦åœ¨é¡µé¢æŒ‰é’®å¯¹åº”çš„controlleræ–¹æ³•ä¸Šé¢åŠ å¯¹åº”çš„æƒé™æ§åˆ¶ï¼Œå³åœ¨è¿›å…¥controlleræ–¹æ³•å‰åˆ¤æ–­å½“å‰ç”¨æˆ·æ˜¯å¦æœ‰è®¿é—®æƒé™ã€‚

æ€ä¹ˆå®ç°å‘¢ï¼Ÿå¦‚æœæˆ‘ä»¬è‡ªå·±å®ç°ï¼Œé‚£ä¹ˆè‚¯å®šæƒ³åˆ°çš„å°±æ˜¯**FillteråŠ Aop**å°±å¯ä»¥å®ç°ï¼Œæœ‰ç°æˆçš„å¼€æºæŠ€æœ¯æ¡†æ¶å—ï¼Ÿç­”æ¡ˆæ˜¯è‚¯å®šçš„ï¼Œå¦‚ï¼šSpring Securityã€Shiroç­‰ä¸€ç³»åˆ—å¼€æºæ¡†æ¶å¯ä¾›é€‰æ‹©ã€‚

**è¿‡æ»¤å™¨èƒ½å®ç°æ‹¦æˆªè¯·æ±‚åŠŸèƒ½ï¼ŒAOPèƒ½åœ¨ä¸æ”¹å˜æºç çš„æƒ…å†µä¸‹å¢å¼ºåŠŸèƒ½ã€‚**

## Spring Security

### 1ã€Spring Securityç®€ä»‹

Spring æ˜¯éå¸¸æµè¡Œå’ŒæˆåŠŸçš„ Java åº”ç”¨å¼€å‘æ¡†æ¶ï¼ŒSpring Security æ­£æ˜¯ Spring å®¶æ—ä¸­çš„æˆå‘˜ã€‚Spring Security åŸºäº Spring æ¡†æ¶ï¼Œæä¾›äº†ä¸€å¥— Web åº”ç”¨å®‰å…¨æ€§çš„å®Œæ•´è§£å†³æ–¹æ¡ˆã€‚

æ­£å¦‚ä½ å¯èƒ½çŸ¥é“çš„å…³äºå®‰å…¨æ–¹é¢çš„ä¸¤ä¸ªæ ¸å¿ƒåŠŸèƒ½æ˜¯â€œ**è®¤è¯**â€å’Œâ€œ**æˆæƒ**â€ï¼Œä¸€èˆ¬æ¥è¯´ï¼ŒWeb åº”ç”¨çš„å®‰å…¨æ€§åŒ…æ‹¬**ç”¨æˆ·è®¤è¯ï¼ˆAuthenticationï¼‰å’Œç”¨æˆ·æˆæƒï¼ˆAuthorizationï¼‰**ä¸¤ä¸ªéƒ¨åˆ†ï¼Œè¿™ä¸¤ç‚¹ä¹Ÿæ˜¯ SpringSecurity é‡è¦æ ¸å¿ƒåŠŸèƒ½ã€‚

ï¼ˆ1ï¼‰ç”¨æˆ·è®¤è¯æŒ‡çš„æ˜¯ï¼šéªŒè¯æŸä¸ªç”¨æˆ·æ˜¯å¦ä¸ºç³»ç»Ÿä¸­çš„åˆæ³•ä¸»ä½“ï¼Œä¹Ÿå°±æ˜¯è¯´ç”¨æˆ·èƒ½å¦è®¿é—®è¯¥ç³»ç»Ÿã€‚ç”¨æˆ·è®¤è¯ä¸€èˆ¬è¦æ±‚ç”¨æˆ·æä¾›ç”¨æˆ·åå’Œå¯†ç ï¼Œç³»ç»Ÿé€šè¿‡æ ¡éªŒç”¨æˆ·åå’Œå¯†ç æ¥å®Œæˆè®¤è¯è¿‡ç¨‹ã€‚

**é€šä¿—ç‚¹è¯´å°±æ˜¯ç³»ç»Ÿè®¤ä¸ºç”¨æˆ·æ˜¯å¦èƒ½ç™»å½•**

ï¼ˆ2ï¼‰ç”¨æˆ·æˆæƒæŒ‡çš„æ˜¯éªŒè¯æŸä¸ªç”¨æˆ·æ˜¯å¦æœ‰æƒé™æ‰§è¡ŒæŸä¸ªæ“ä½œã€‚åœ¨ä¸€ä¸ªç³»ç»Ÿä¸­ï¼Œä¸åŒç”¨æˆ·æ‰€å…·æœ‰çš„æƒé™æ˜¯ä¸åŒçš„ã€‚æ¯”å¦‚å¯¹ä¸€ä¸ªæ–‡ä»¶æ¥è¯´ï¼Œæœ‰çš„ç”¨æˆ·åªèƒ½è¿›è¡Œè¯»å–ï¼Œè€Œæœ‰çš„ç”¨æˆ·å¯ä»¥è¿›è¡Œä¿®æ”¹ã€‚ä¸€èˆ¬æ¥è¯´ï¼Œç³»ç»Ÿä¼šä¸ºä¸åŒçš„ç”¨æˆ·åˆ†é…ä¸åŒçš„è§’è‰²ï¼Œè€Œæ¯ä¸ªè§’è‰²åˆ™å¯¹åº”ä¸€ç³»åˆ—çš„æƒé™ã€‚

**é€šä¿—ç‚¹è®²å°±æ˜¯ç³»ç»Ÿåˆ¤æ–­ç”¨æˆ·æ˜¯å¦æœ‰æƒé™å»åšæŸäº›äº‹æƒ…ã€‚**

### 2ã€å†å²

â€œSpring Security å¼€å§‹äº 2003 å¹´å¹´åº•,â€œâ€œspring çš„ acegi å®‰å…¨ç³»ç»Ÿâ€ã€‚ èµ·å› æ˜¯ Springå¼€å‘è€…é‚®ä»¶åˆ—è¡¨ä¸­çš„ä¸€ä¸ªé—®é¢˜,æœ‰äººæé—®æ˜¯å¦è€ƒè™‘æä¾›ä¸€ä¸ªåŸºäº spring çš„å®‰å…¨å®ç°ã€‚

Spring Security ä»¥â€œThe Acegi Secutity System for Springâ€ çš„åå­—å§‹äº 2013 å¹´æ™šäº›æ—¶å€™ã€‚ä¸€ä¸ªé—®é¢˜æäº¤åˆ° Spring å¼€å‘è€…çš„é‚®ä»¶åˆ—è¡¨ï¼Œè¯¢é—®æ˜¯å¦å·²ç»æœ‰è€ƒè™‘ä¸€ä¸ªæœºé‡ Spring çš„å®‰å…¨æ€§ç¤¾åŒºå®ç°ã€‚é‚£æ—¶å€™ Spring çš„ç¤¾åŒºç›¸å¯¹è¾ƒå°ï¼ˆç›¸å¯¹ç°åœ¨ï¼‰ã€‚å®é™…ä¸Š Spring è‡ªå·±åœ¨2013 å¹´åªæ˜¯ä¸€ä¸ªå­˜åœ¨äº ScourseForge çš„é¡¹ç›®ï¼Œè¿™ä¸ªé—®é¢˜çš„å›ç­”æ˜¯ä¸€ä¸ªå€¼å¾—ç ”ç©¶çš„é¢†åŸŸï¼Œè™½ç„¶ç›®å‰æ—¶é—´çš„ç¼ºä¹ç»„ç»‡äº†æˆ‘ä»¬å¯¹å®ƒçš„æ¢ç´¢ã€‚

è€ƒè™‘åˆ°è¿™ä¸€ç‚¹ï¼Œä¸€ä¸ªç®€å•çš„å®‰å…¨å®ç°å»ºæˆä½†æ˜¯å¹¶æ²¡æœ‰å‘å¸ƒã€‚å‡ å‘¨åï¼ŒSpring ç¤¾åŒºçš„å…¶ä»–æˆå‘˜è¯¢é—®äº†å®‰å…¨æ€§ï¼Œè¿™æ¬¡è¿™ä¸ªä»£ç è¢«å‘é€ç»™ä»–ä»¬ã€‚å…¶ä»–å‡ ä¸ªè¯·æ±‚ä¹Ÿè·Ÿéšè€Œæ¥ã€‚åˆ° 2014 å¹´ä¸€æœˆå¤§çº¦æœ‰ 20 ä¸‡äººä½¿ç”¨äº†è¿™ä¸ªä»£ç ã€‚è¿™äº›åˆ›ä¸šè€…çš„äººæå‡ºä¸€ä¸ª SourceForge é¡¹ç›®åŠ å…¥æ˜¯ä¸ºäº†ï¼Œè¿™æ˜¯åœ¨ 2004 ä¸‰æœˆæ­£å¼æˆç«‹ã€‚

åœ¨æ—©äº›æ—¶å€™ï¼Œè¿™ä¸ªé¡¹ç›®æ²¡æœ‰ä»»ä½•è‡ªå·±çš„éªŒè¯æ¨¡å—ï¼Œèº«ä»½éªŒè¯è¿‡ç¨‹ä¾èµ–äºå®¹å™¨ç®¡ç†çš„å®‰å…¨æ€§å’Œ Acegi å®‰å…¨æ€§ã€‚è€Œä¸æ˜¯ä¸“æ³¨äºæˆæƒã€‚å¼€å§‹çš„æ—¶å€™è¿™å¾ˆé€‚åˆï¼Œä½†æ˜¯è¶Šæ¥è¶Šå¤šçš„ç”¨æˆ·è¯·æ±‚é¢å¤–çš„å®¹å™¨æ”¯æŒã€‚å®¹å™¨ç‰¹å®šçš„è®¤è¯é¢†åŸŸæ¥å£çš„åŸºæœ¬é™åˆ¶å˜å¾—æ¸…æ™°ã€‚è¿˜æœ‰ä¸€ä¸ªç›¸å…³çš„é—®é¢˜å¢åŠ æ–°çš„å®¹å™¨çš„è·¯å¾„ï¼Œè¿™æ˜¯æœ€ç»ˆç”¨æˆ·çš„å›°æƒ‘å’Œé”™è¯¯é…ç½®çš„å¸¸è§é—®é¢˜ã€‚

Acegi å®‰å…¨ç‰¹å®šçš„è®¤è¯æœåŠ¡ä»‹ç»ã€‚å¤§çº¦ä¸€å¹´åï¼ŒAcegi å®‰å…¨æ­£å¼æˆä¸ºäº† Spring æ¡†æ¶çš„å­é¡¹ç›®ã€‚1.0.0 æœ€ç»ˆç‰ˆæœ¬æ˜¯å‡ºç‰ˆäº 2006 -åœ¨è¶…è¿‡ä¸¤å¹´åŠçš„å¤§é‡ç”Ÿäº§çš„è½¯ä»¶é¡¹ç›®å’Œæ•°ä»¥ç™¾è®¡çš„æ”¹è¿›å’Œç§¯æåˆ©ç”¨ç¤¾åŒºçš„è´¡çŒ®ã€‚

Acegi å®‰å…¨ 2007 å¹´åº•æ­£å¼æˆä¸ºäº† Spring ç»„åˆé¡¹ç›®ï¼Œæ›´åä¸º"Spring Security"ã€‚

### 3ã€åŒæ¬¾äº§å“å¯¹æ¯”

#### 3.1ã€Spring Security

Spring æŠ€æœ¯æ ˆçš„ç»„æˆéƒ¨åˆ†ã€‚

https://spring.io/projects/spring-security

é€šè¿‡æä¾›å®Œæ•´å¯æ‰©å±•çš„è®¤è¯å’Œæˆæƒæ”¯æŒä¿æŠ¤ä½ çš„åº”ç”¨ç¨‹åºã€‚

**SpringSecurity ç‰¹ç‚¹ï¼š**

âš« å’Œ Spring æ— ç¼æ•´åˆã€‚

âš« å…¨é¢çš„æƒé™æ§åˆ¶ã€‚

âš« ä¸“é—¨ä¸º Web å¼€å‘è€Œè®¾è®¡ã€‚

â€‹	â—¼æ—§ç‰ˆæœ¬ä¸èƒ½è„±ç¦» Web ç¯å¢ƒä½¿ç”¨ã€‚

â€‹	â—¼æ–°ç‰ˆæœ¬å¯¹æ•´ä¸ªæ¡†æ¶è¿›è¡Œäº†åˆ†å±‚æŠ½å–ï¼Œåˆ†æˆäº†æ ¸å¿ƒæ¨¡å—å’Œ Web æ¨¡å—ã€‚å•ç‹¬å¼•å…¥æ ¸å¿ƒæ¨¡å—å°±å¯ä»¥è„±ç¦» Web ç¯å¢ƒã€‚

âš« é‡é‡çº§ã€‚

#### 3.2ã€ Shiro

Apache æ——ä¸‹çš„è½»é‡çº§æƒé™æ§åˆ¶æ¡†æ¶ã€‚

**ç‰¹ç‚¹ï¼š**

âš« è½»é‡çº§ã€‚Shiro ä¸»å¼ çš„ç†å¿µæ˜¯æŠŠå¤æ‚çš„äº‹æƒ…å˜ç®€å•ã€‚é’ˆå¯¹å¯¹æ€§èƒ½æœ‰æ›´é«˜è¦æ±‚

çš„äº’è”ç½‘åº”ç”¨æœ‰æ›´å¥½è¡¨ç°ã€‚

âš« é€šç”¨æ€§ã€‚

â€‹	â—¼å¥½å¤„ï¼šä¸å±€é™äº Web ç¯å¢ƒï¼Œå¯ä»¥è„±ç¦» Web ç¯å¢ƒä½¿ç”¨ã€‚

â€‹	â—¼ç¼ºé™·ï¼šåœ¨ Web ç¯å¢ƒä¸‹ä¸€äº›ç‰¹å®šçš„éœ€æ±‚éœ€è¦æ‰‹åŠ¨ç¼–å†™ä»£ç å®šåˆ¶ã€‚

Spring Security æ˜¯ Spring å®¶æ—ä¸­çš„ä¸€ä¸ªå®‰å…¨ç®¡ç†æ¡†æ¶ï¼Œå®é™…ä¸Šï¼Œåœ¨ Spring Boot å‡ºç°ä¹‹å‰ï¼ŒSpring Security å°±å·²ç»å‘å±•äº†å¤šå¹´äº†ï¼Œä½†æ˜¯ä½¿ç”¨çš„å¹¶ä¸å¤šï¼Œå®‰å…¨ç®¡ç†è¿™ä¸ªé¢†åŸŸï¼Œä¸€ç›´æ˜¯ Shiro çš„å¤©ä¸‹ã€‚

ç›¸å¯¹äº Shiroï¼Œåœ¨ SSM ä¸­æ•´åˆ Spring Security éƒ½æ˜¯æ¯”è¾ƒéº»çƒ¦çš„æ“ä½œï¼Œæ‰€ä»¥ï¼ŒSpring Security è™½ç„¶åŠŸèƒ½æ¯” Shiro å¼ºå¤§ï¼Œä½†æ˜¯ä½¿ç”¨åè€Œæ²¡æœ‰ Shiro å¤šï¼ˆShiro è™½ç„¶åŠŸèƒ½æ²¡æœ‰Spring Security å¤šï¼Œä½†æ˜¯å¯¹äºå¤§éƒ¨åˆ†é¡¹ç›®è€Œè¨€ï¼ŒShiro ä¹Ÿå¤Ÿç”¨äº†ï¼‰ã€‚

è‡ªä»æœ‰äº† Spring Boot ä¹‹åï¼ŒSpring Boot å¯¹äº Spring Security æä¾›äº†è‡ªåŠ¨åŒ–é…ç½®æ–¹æ¡ˆï¼Œå¯ä»¥ä½¿ç”¨æ›´å°‘çš„é…ç½®æ¥ä½¿ç”¨ Spring Securityã€‚

å› æ­¤ï¼Œä¸€èˆ¬æ¥è¯´ï¼Œå¸¸è§çš„å®‰å…¨ç®¡ç†æŠ€æœ¯æ ˆçš„ç»„åˆæ˜¯è¿™æ ·çš„ï¼š

â€¢ SSM + Shiro

â€¢ Spring Boot/Spring Cloud + Spring Security

**ä»¥ä¸Šåªæ˜¯ä¸€ä¸ªæ¨èçš„ç»„åˆè€Œå·²ï¼Œå¦‚æœå•çº¯ä»æŠ€æœ¯ä¸Šæ¥è¯´ï¼Œæ— è®ºæ€ä¹ˆç»„åˆï¼Œéƒ½æ˜¯å¯ä»¥è¿è¡Œçš„**



## Spring Securityå®ç°æƒé™

è¦å¯¹Webèµ„æºè¿›è¡Œä¿æŠ¤ï¼Œæœ€å¥½çš„åŠæ³•è«è¿‡äºFilter
è¦æƒ³å¯¹æ–¹æ³•è°ƒç”¨è¿›è¡Œä¿æŠ¤ï¼Œæœ€å¥½çš„åŠæ³•è«è¿‡äºAOPã€‚

Spring Securityè¿›è¡Œè®¤è¯å’Œé‰´æƒçš„æ—¶å€™,å°±æ˜¯åˆ©ç”¨çš„ä¸€ç³»åˆ—çš„Filteræ¥è¿›è¡Œæ‹¦æˆªçš„ã€‚

![](images/20201231155747261.png)



å¦‚å›¾æ‰€ç¤ºï¼Œä¸€ä¸ªè¯·æ±‚æƒ³è¦è®¿é—®åˆ°APIå°±ä¼šä»å·¦åˆ°å³ç»è¿‡è“çº¿æ¡†é‡Œçš„è¿‡æ»¤å™¨ï¼Œå…¶ä¸­**ç»¿è‰²éƒ¨åˆ†æ˜¯è´Ÿè´£è®¤è¯çš„è¿‡æ»¤å™¨ï¼Œè“è‰²éƒ¨åˆ†æ˜¯è´Ÿè´£å¼‚å¸¸å¤„ç†ï¼Œæ©™è‰²éƒ¨åˆ†åˆ™æ˜¯è´Ÿè´£æˆæƒ**ã€‚è¿›è¿‡ä¸€ç³»åˆ—æ‹¦æˆªæœ€ç»ˆè®¿é—®åˆ°æˆ‘ä»¬çš„APIã€‚

è¿™é‡Œé¢æˆ‘ä»¬åªéœ€è¦é‡ç‚¹å…³æ³¨ä¸¤ä¸ªè¿‡æ»¤å™¨å³å¯ï¼š`UsernamePasswordAuthenticationFilter`è´Ÿè´£ç™»å½•è®¤è¯ï¼Œ`FilterSecurityInterceptor`è´Ÿè´£æƒé™æˆæƒã€‚

è¯´æ˜ï¼š**Spring Securityçš„æ ¸å¿ƒé€»è¾‘å…¨åœ¨è¿™ä¸€å¥—è¿‡æ»¤å™¨ä¸­ï¼Œè¿‡æ»¤å™¨é‡Œä¼šè°ƒç”¨å„ç§ç»„ä»¶å®ŒæˆåŠŸèƒ½ï¼ŒæŒæ¡äº†è¿™äº›è¿‡æ»¤å™¨å’Œç»„ä»¶ä½ å°±æŒæ¡äº†Spring Security**ï¼è¿™ä¸ªæ¡†æ¶çš„ä½¿ç”¨æ–¹å¼å°±æ˜¯å¯¹è¿™äº›è¿‡æ»¤å™¨å’Œç»„ä»¶è¿›è¡Œæ‰©å±•ã€‚

### 1 å…¥é—¨

#### åˆ›å»ºspring-securityæ¨¡å—

åœ¨commonæ¨¡å—ä¸‹åˆ›å»ºspring-securityå…¬å…±æ¨¡å—

#### æ·»åŠ ä¾èµ–



#### æ·»åŠ é…ç½®ç±»



#### service-systemæ¨¡å—å¼•å…¥



#### å¯åŠ¨é¡¹ç›®æµ‹è¯•

åœ¨æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8800/admin/system/sysRole/findAll

è‡ªåŠ¨è·³è½¬åˆ°äº†Spring Securityé»˜è®¤çš„ç™»å½•é¡µé¢äº†ã€‚



é»˜è®¤çš„ç”¨æˆ·åï¼šuser

å¯†ç åœ¨é¡¹ç›®å¯åŠ¨çš„æ—¶å€™åœ¨æ§åˆ¶å°ä¼šæ‰“å°ï¼Œ**æ³¨æ„æ¯æ¬¡å¯åŠ¨çš„æ—¶å€™å¯†ç éƒ½ä¼šå‘ç”Ÿå˜åŒ–ï¼**



è¾“å…¥ç”¨æˆ·åï¼Œå¯†ç ï¼ŒæˆåŠŸè®¿é—®åˆ°controlleræ–¹æ³•å¹¶è¿”å›æ•°æ®ï¼Œè¯´æ˜Spring Securityé»˜è®¤å®‰å…¨ä¿æŠ¤ç”Ÿæ•ˆã€‚

åœ¨å®é™…å¼€å‘ä¸­ï¼Œè¿™äº›é»˜è®¤çš„é…ç½®æ˜¯ä¸èƒ½æ»¡è¶³æˆ‘ä»¬éœ€è¦çš„ï¼Œæˆ‘ä»¬éœ€è¦æ‰©å±•Spring Securityç»„ä»¶ï¼Œå®Œæˆè‡ªå®šä¹‰é…ç½®ï¼Œå®ç°æˆ‘ä»¬çš„é¡¹ç›®éœ€æ±‚ã€‚

### 2 ç”¨æˆ·è®¤è¯

ç”¨æˆ·è®¤è¯æµç¨‹ï¼š

![](images/image-20220620115942257.png)

`UsernamePasswordAuthenticationFilter`

ğŸ”–p97 æºç è®¤è¯æµç¨‹

#### 2.1 ç”¨æˆ·è®¤è¯æ ¸å¿ƒç»„ä»¶

æˆ‘ä»¬ç³»ç»Ÿä¸­ä¼šæœ‰è®¸å¤šç”¨æˆ·ï¼Œç¡®è®¤å½“å‰æ˜¯å“ªä¸ªç”¨æˆ·æ­£åœ¨ä½¿ç”¨æˆ‘ä»¬ç³»ç»Ÿå°±æ˜¯ç™»å½•è®¤è¯çš„æœ€ç»ˆç›®çš„ã€‚è¿™é‡Œæˆ‘ä»¬å°±æå–å‡ºäº†ä¸€ä¸ªæ ¸å¿ƒæ¦‚å¿µï¼š**å½“å‰ç™»å½•ç”¨æˆ·/å½“å‰è®¤è¯ç”¨æˆ·**ã€‚æ•´ä¸ªç³»ç»Ÿå®‰å…¨éƒ½æ˜¯å›´ç»•å½“å‰ç™»å½•ç”¨æˆ·å±•å¼€çš„ï¼Œè¿™ä¸ªä¸éš¾ç†è§£ï¼Œè¦æ˜¯å½“å‰ç™»å½•ç”¨æˆ·éƒ½ä¸èƒ½ç¡®è®¤äº†ï¼Œé‚£Aä¸‹äº†ä¸€ä¸ªè®¢å•ï¼Œä¸‹åˆ°äº†Bçš„è´¦æˆ·ä¸Šè¿™ä¸å°±ä¹±å¥—äº†ã€‚è¿™ä¸€æ¦‚å¿µåœ¨Spring Securityä¸­çš„ä½“ç°å°±æ˜¯ **`Authentication`**ï¼Œå®ƒå­˜å‚¨äº†è®¤è¯ä¿¡æ¯ï¼Œä»£è¡¨å½“å‰ç™»å½•ç”¨æˆ·ã€‚

æˆ‘ä»¬åœ¨ç¨‹åºä¸­å¦‚ä½•è·å–å¹¶ä½¿ç”¨å®ƒå‘¢ï¼Ÿæˆ‘ä»¬éœ€è¦é€šè¿‡ **`SecurityContext`** æ¥è·å–`Authentication`ï¼Œ`SecurityContext`å°±æ˜¯æˆ‘ä»¬çš„ä¸Šä¸‹æ–‡å¯¹è±¡ï¼è¿™ä¸ªä¸Šä¸‹æ–‡å¯¹è±¡åˆ™æ˜¯äº¤ç”± **`SecurityContextHolder`** è¿›è¡Œç®¡ç†ï¼Œä½ å¯ä»¥åœ¨ç¨‹åº**ä»»ä½•åœ°æ–¹**ä½¿ç”¨å®ƒï¼š

```java
Authentication authentication = SecurityContextHolder.getContext().getAuthentication();
```

`SecurityContextHolder`åŸç†éå¸¸ç®€å•ï¼Œå°±æ˜¯ä½¿ç”¨`ThreadLocal`æ¥ä¿è¯ä¸€ä¸ªçº¿ç¨‹ä¸­ä¼ é€’åŒä¸€ä¸ªå¯¹è±¡ï¼

**ç°åœ¨æˆ‘ä»¬å·²ç»çŸ¥é“äº†Spring Securityä¸­ä¸‰ä¸ªæ ¸å¿ƒç»„ä»¶ï¼š**

â€‹	1ã€`Authentication`ï¼šå­˜å‚¨äº†è®¤è¯ä¿¡æ¯ï¼Œä»£è¡¨å½“å‰ç™»å½•ç”¨æˆ·

â€‹	2ã€`SeucirtyContext`ï¼šä¸Šä¸‹æ–‡å¯¹è±¡ï¼Œç”¨æ¥è·å–`Authentication`

â€‹	3ã€`SecurityContextHolder`ï¼šä¸Šä¸‹æ–‡ç®¡ç†å¯¹è±¡ï¼Œç”¨æ¥åœ¨ç¨‹åºä»»ä½•åœ°æ–¹è·å–`SecurityContext`

**`Authentication`ä¸­æ˜¯ä»€ä¹ˆä¿¡æ¯å‘¢ï¼š**

â€‹	1ã€`Principal`ï¼šç”¨æˆ·ä¿¡æ¯ï¼Œæ²¡æœ‰è®¤è¯æ—¶ä¸€èˆ¬æ˜¯ç”¨æˆ·åï¼Œè®¤è¯åä¸€èˆ¬æ˜¯ç”¨æˆ·å¯¹è±¡

â€‹	2ã€`Credentials`ï¼šç”¨æˆ·å‡­è¯ï¼Œä¸€èˆ¬æ˜¯å¯†ç 

â€‹	3ã€`Authorities`ï¼šç”¨æˆ·æƒé™

#### 2.2 ç”¨æˆ·è®¤è¯

Spring Securityæ˜¯æ€ä¹ˆè¿›è¡Œç”¨æˆ·è®¤è¯çš„å‘¢ï¼Ÿ

**`AuthenticationManager`** å°±æ˜¯Spring Securityç”¨äºæ‰§è¡Œèº«ä»½éªŒè¯çš„ç»„ä»¶ï¼Œåªéœ€è¦è°ƒç”¨å®ƒçš„`authenticate`æ–¹æ³•å³å¯å®Œæˆè®¤è¯ã€‚Spring Securityé»˜è®¤çš„è®¤è¯æ–¹å¼å°±æ˜¯åœ¨`UsernamePasswordAuthenticationFilter`è¿™ä¸ªè¿‡æ»¤å™¨ä¸­è¿›è¡Œè®¤è¯çš„ï¼Œè¯¥è¿‡æ»¤å™¨è´Ÿè´£è®¤è¯é€»è¾‘ã€‚

Spring Securityç”¨æˆ·è®¤è¯å…³é”®ä»£ç å¦‚ä¸‹ï¼š

```java
// ç”Ÿæˆä¸€ä¸ªåŒ…å«è´¦å·å¯†ç çš„è®¤è¯ä¿¡æ¯
Authentication authenticationToken = new UsernamePasswordAuthenticationToken(username, passwrod);
// AuthenticationManageræ ¡éªŒè¿™ä¸ªè®¤è¯ä¿¡æ¯ï¼Œè¿”å›ä¸€ä¸ªå·²è®¤è¯çš„Authentication
Authentication authentication = authenticationManager.authenticate(authenticationToken);
// å°†è¿”å›çš„Authenticationå­˜åˆ°ä¸Šä¸‹æ–‡ä¸­
SecurityContextHolder.getContext().setAuthentication(authentication);
```

ä¸‹é¢æˆ‘ä»¬æ¥åˆ†æä¸€ä¸‹ã€‚

##### 2.2.1 è®¤è¯æ¥å£åˆ†æ

`AuthenticationManager`çš„æ ¡éªŒé€»è¾‘éå¸¸ç®€å•ï¼š

æ ¹æ®ç”¨æˆ·åå…ˆæŸ¥è¯¢å‡ºç”¨æˆ·å¯¹è±¡(æ²¡æœ‰æŸ¥åˆ°åˆ™æŠ›å‡ºå¼‚å¸¸)å°†ç”¨æˆ·å¯¹è±¡çš„å¯†ç å’Œä¼ é€’è¿‡æ¥çš„å¯†ç è¿›è¡Œæ ¡éªŒï¼Œå¯†ç ä¸åŒ¹é…åˆ™æŠ›å‡ºå¼‚å¸¸ã€‚

è¿™ä¸ªé€»è¾‘æ²¡å•¥å¥½è¯´çš„ï¼Œå†ç®€å•ä¸è¿‡äº†ã€‚é‡ç‚¹æ˜¯è¿™é‡Œæ¯ä¸€ä¸ªæ­¥éª¤Spring Securityéƒ½æä¾›äº†ç»„ä»¶ï¼š

â€‹	1ã€æ˜¯è°æ‰§è¡Œ **æ ¹æ®ç”¨æˆ·åæŸ¥è¯¢å‡ºç”¨æˆ·å¯¹è±¡** é€»è¾‘çš„å‘¢ï¼Ÿç”¨æˆ·å¯¹è±¡æ•°æ®å¯ä»¥å­˜åœ¨å†…å­˜ä¸­ã€æ–‡ä»¶ä¸­ã€æ•°æ®åº“ä¸­ï¼Œä½ å¾—ç¡®å®šå¥½æ€ä¹ˆæŸ¥æ‰è¡Œã€‚è¿™ä¸€éƒ¨åˆ†å°±æ˜¯äº¤ç”±**`UserDetialsService`** å¤„ç†ï¼Œè¯¥æ¥å£åªæœ‰ä¸€ä¸ªæ–¹æ³•`loadUserByUsername(String username)`ï¼Œé€šè¿‡ç”¨æˆ·åæŸ¥è¯¢ç”¨æˆ·å¯¹è±¡ï¼Œé»˜è®¤å®ç°æ˜¯åœ¨å†…å­˜ä¸­æŸ¥è¯¢ã€‚

â€‹	2ã€é‚£æŸ¥è¯¢å‡ºæ¥çš„ **ç”¨æˆ·å¯¹è±¡** åˆæ˜¯ä»€ä¹ˆå‘¢ï¼Ÿæ¯ä¸ªç³»ç»Ÿä¸­çš„ç”¨æˆ·å¯¹è±¡æ•°æ®éƒ½ä¸å°½ç›¸åŒï¼Œå’±ä»¬éœ€è¦ç¡®è®¤æˆ‘ä»¬çš„ç”¨æˆ·æ•°æ®æ˜¯å•¥æ ·çš„æ‰è¡Œã€‚Spring Securityä¸­çš„ç”¨æˆ·æ•°æ®åˆ™æ˜¯ç”±**`UserDetails`** æ¥ä½“ç°ï¼Œè¯¥æ¥å£ä¸­æä¾›äº†è´¦å·ã€å¯†ç ç­‰é€šç”¨å±æ€§ã€‚

â€‹	3ã€**å¯¹å¯†ç è¿›è¡Œæ ¡éªŒ**å¤§å®¶å¯èƒ½ä¼šè§‰å¾—æ¯”è¾ƒç®€å•ï¼Œ`ifã€else`æå®šï¼Œå°±æ²¡å¿…è¦ç”¨ä»€ä¹ˆç»„ä»¶äº†å§ï¼Ÿä½†æ¡†æ¶æ¯•ç«Ÿæ˜¯æ¡†æ¶è€ƒè™‘çš„æ¯”è¾ƒå‘¨å…¨ï¼Œé™¤äº†`ifã€else`å¤–è¿˜è§£å†³äº†å¯†ç åŠ å¯†çš„é—®é¢˜ï¼Œè¿™ä¸ªç»„ä»¶å°±æ˜¯**`PasswordEncoder`**ï¼Œè´Ÿè´£å¯†ç åŠ å¯†ä¸æ ¡éªŒã€‚

æˆ‘ä»¬å¯ä»¥çœ‹ä¸‹`AuthenticationManager`æ ¡éªŒé€»è¾‘çš„å¤§æ¦‚æºç ï¼š

```java
public Authentication authenticate(Authentication authentication) throws AuthenticationException {
...çœç•¥å…¶ä»–ä»£ç 

    // ä¼ é€’è¿‡æ¥çš„ç”¨æˆ·å
    String username = authentication.getName();
    // è°ƒç”¨UserDetailServiceçš„æ–¹æ³•ï¼Œé€šè¿‡ç”¨æˆ·åæŸ¥è¯¢å‡ºç”¨æˆ·å¯¹è±¡UserDetailï¼ˆæŸ¥è¯¢ä¸å‡ºæ¥UserDetailServiceåˆ™ä¼šæŠ›å‡ºå¼‚å¸¸ï¼‰
    UserDetails userDetails = this.getUserDetailsService().loadUserByUsername(username);
    String presentedPassword = authentication.getCredentials().toString();

    // ä¼ é€’è¿‡æ¥çš„å¯†ç 
    String password = authentication.getCredentials().toString();
    // ä½¿ç”¨å¯†ç è§£æå™¨PasswordEncoderä¼ é€’è¿‡æ¥çš„å¯†ç æ˜¯å¦å’ŒçœŸå®çš„ç”¨æˆ·å¯†ç åŒ¹é…
    if (!passwordEncoder.matches(password, userDetails.getPassword())) {
        // å¯†ç é”™è¯¯åˆ™æŠ›å‡ºå¼‚å¸¸
        throw new BadCredentialsException("é”™è¯¯ä¿¡æ¯...");
    }

    // æ³¨æ„å“¦ï¼Œè¿™é‡Œè¿”å›çš„å·²è®¤è¯Authenticationï¼Œæ˜¯å°†æ•´ä¸ªUserDetailsæ”¾è¿›å»å……å½“Principal
    UsernamePasswordAuthenticationToken result = new UsernamePasswordAuthenticationToken(userDetails,
            authentication.getCredentials(), userDetails.getAuthorities());
    return result;

...çœç•¥å…¶ä»–ä»£ç 
}
```

`UserDetialsService`ã€`UserDetails`ã€`PasswordEncoder`ï¼Œè¿™ä¸‰ä¸ªç»„ä»¶Spring Securityéƒ½æœ‰é»˜è®¤å®ç°ï¼Œè¿™ä¸€èˆ¬æ˜¯æ»¡è¶³ä¸äº†æˆ‘ä»¬çš„å®é™…éœ€æ±‚çš„ï¼Œæ‰€ä»¥è¿™é‡Œæˆ‘ä»¬è‡ªå·±æ¥å®ç°è¿™äº›ç»„ä»¶ï¼

ä¸‹é¢æˆ‘ä»¬å°±åœ¨é¡¹ç›®é‡Œé¢æ¥å®ç°ç”¨æˆ·è®¤è¯ã€‚



![](images/image-20230329212847023.png)

##### 2.2.3 åŠ å¯†å™¨PasswordEncoder

åŠ å¯†æˆ‘ä»¬é¡¹ç›®é‡‡å–MD5åŠ å¯†

æ“ä½œæ¨¡å—ï¼šspring-securityæ¨¡å—

**è‡ªå®šä¹‰åŠ å¯†å¤„ç†ç»„ä»¶ï¼šCustomMd5Password**

```java
/**
 * è‡ªå®šä¹‰å¯†ç ç»„ä»¶
 * @author andyron
 **/
@Component
public class CustomMd5Password implements PasswordEncoder {
    @Override
    public String encode(CharSequence rawPassword) {
        return MD5.encrypt(rawPassword.toString());
    }

    @Override
    public boolean matches(CharSequence rawPassword, String encodedPassword) {
        return encodedPassword.equals(MD5.encrypt(rawPassword.toString()));
    }
}
```

##### 2.2.4ã€ç”¨æˆ·å¯¹è±¡UserDetails

è¯¥æ¥å£å°±æ˜¯æˆ‘ä»¬æ‰€è¯´çš„ç”¨æˆ·å¯¹è±¡ï¼Œå®ƒæä¾›äº†ç”¨æˆ·çš„ä¸€äº›é€šç”¨å±æ€§ï¼Œæºç å¦‚ä¸‹ï¼š

```java
public interface UserDetails extends Serializable {
	/**
     * ç”¨æˆ·æƒé™é›†åˆï¼ˆè¿™ä¸ªæƒé™å¯¹è±¡ç°åœ¨ä¸ç®¡å®ƒï¼Œåˆ°æƒé™æ—¶æˆ‘ä¼šè®²è§£ï¼‰
     */
    Collection<? extends GrantedAuthority> getAuthorities();
    /**
     * ç”¨æˆ·å¯†ç 
     */
    String getPassword();
    /**
     * ç”¨æˆ·å
     */
    String getUsername();
    /**
     * ç”¨æˆ·æ²¡è¿‡æœŸè¿”å›trueï¼Œåä¹‹åˆ™false
     */
    boolean isAccountNonExpired();
    /**
     * ç”¨æˆ·æ²¡é”å®šè¿”å›trueï¼Œåä¹‹åˆ™false
     */
    boolean isAccountNonLocked();
    /**
     * ç”¨æˆ·å‡­æ®(é€šå¸¸ä¸ºå¯†ç )æ²¡è¿‡æœŸè¿”å›trueï¼Œåä¹‹åˆ™false
     */
    boolean isCredentialsNonExpired();
    /**
     * ç”¨æˆ·æ˜¯å¯ç”¨çŠ¶æ€è¿”å›trueï¼Œåä¹‹åˆ™false
     */
    boolean isEnabled();
}
```

å®é™…å¼€å‘ä¸­æˆ‘ä»¬çš„ç”¨æˆ·å±æ€§å„ç§å„æ ·ï¼Œè¿™äº›é»˜è®¤å±æ€§å¯èƒ½æ˜¯æ»¡è¶³ä¸äº†ï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸€èˆ¬ä¼šè‡ªå·±å®ç°è¯¥æ¥å£ï¼Œç„¶åè®¾ç½®å¥½æˆ‘ä»¬å®é™…çš„ç”¨æˆ·å®ä½“å¯¹è±¡ã€‚å®ç°æ­¤æ¥å£è¦é‡å†™å¾ˆå¤šæ–¹æ³•æ¯”è¾ƒéº»çƒ¦ï¼Œæˆ‘ä»¬å¯ä»¥ç»§æ‰¿Spring Securityæä¾›çš„`org.springframework.security.core.userdetails.User`ç±»ï¼Œè¯¥ç±»å®ç°äº†`UserDetails`æ¥å£å¸®æˆ‘ä»¬çœå»äº†é‡å†™æ–¹æ³•çš„å·¥ä½œï¼š

æ“ä½œæ¨¡å—ï¼šspring-securityæ¨¡å—

**æ·»åŠ CustomUserå¯¹è±¡**

```java
/**
 * è‡ªå®šä¹‰ç”¨æˆ·ç±»
 * @author andyron
 **/
public class CustomUser extends User {
    private SysUser sysUser;

    public CustomUser(SysUser sysUser, Collection<? extends GrantedAuthority> authorities) {
        super(sysUser.getUsername(), sysUser.getUsername(), authorities);
        this.sysUser = sysUser;
    }

    public SysUser getSysUser() {
        return sysUser;
    }

    public void setSysUser(SysUser sysUser) {
        this.sysUser = sysUser;
    }
}
```

##### 2.2.5 ä¸šåŠ¡å¯¹è±¡UserDetailsService

è¯¥æ¥å£å¾ˆç®€å•åªæœ‰ä¸€ä¸ªæ–¹æ³•ï¼š

```java
public interface UserDetailsService {
    /**
     * æ ¹æ®ç”¨æˆ·åè·å–ç”¨æˆ·å¯¹è±¡ï¼ˆè·å–ä¸åˆ°ç›´æ¥æŠ›å¼‚å¸¸ï¼‰
     */
    UserDetails loadUserByUsername(String username) throws UsernameNotFoundException;
}
```

æˆ‘ä»¬å®ç°è¯¥æ¥å£ï¼Œå°±å®Œæˆäº†è‡ªå·±çš„ä¸šåŠ¡

**æ“ä½œæ¨¡å—ï¼šservice-system**

**æ·»åŠ UserDetailsServiceImplç±»ï¼Œå®ç°UserDetailsServiceæ¥å£**

```java
@Component
public class UserDetailsServiceImpl implements UserDetailsService {
    @Autowired
    SysUserService sysUserService;

    @Override
    public UserDetails loadUserByUsername(String username) throws UsernameNotFoundException {
        SysUser sysUser = sysUserService.getUserInfoByUserName(username);
        if (sysUser == null) {
            throw new UsernameNotFoundException("ç”¨æˆ·ä¸å­˜åœ¨");
        }
        if (sysUser.getStatus().intValue() == 0) {
            throw new RuntimeException("ç”¨æˆ·è¢«ç¦ç”¨äº†");
        }
        return new CustomUser(sysUser, Collections.emptyList());
    }
}
```

`AuthenticationManager`æ ¡éªŒæ‰€è°ƒç”¨çš„ä¸‰ä¸ªç»„ä»¶æˆ‘ä»¬å°±å·²ç»åšå¥½å®ç°äº†ï¼

##### 2.2.6ã€è‡ªå®šä¹‰ç”¨æˆ·è®¤è¯æ¥å£

åœ¨spring-securityæ¨¡å—ä¸­æ·»åŠ TokenLoginFilterï¼š

```java
ppublic class TokenLoginFilter extends UsernamePasswordAuthenticationFilter {

    public TokenLoginFilter(AuthenticationManager authenticationManager) {
        this.setAuthenticationManager(authenticationManager);
        this.setPostOnly(false);
        //
        this.setRequiresAuthenticationRequestMatcher(new AntPathRequestMatcher("/admin/system/index/login", "POST"));
    }
    /**
     * è·å–ç”¨æˆ·åå’Œå¯†ç ï¼Œè®¤è¯
     */
    @Override
    public Authentication attemptAuthentication(HttpServletRequest request, HttpServletResponse response) throws AuthenticationException {
        try {
            LoginVo loginVo = new ObjectMapper().readValue(request.getInputStream(), LoginVo.class);
            Authentication authenticationToken = new UsernamePasswordAuthenticationToken(loginVo.getUsername(), loginVo.getPassword());
            return this.getAuthenticationManager().authenticate(authenticationToken);
        } catch (IOException e) {
            e.printStackTrace();
        }
        return null;
    }
    /**
     * è®¤è¯æˆåŠŸè°ƒç”¨
     */
    @Override
    protected void successfulAuthentication(HttpServletRequest request,
                                            HttpServletResponse response,
                                            FilterChain chain,
                                            Authentication authResult) throws IOException, ServletException {
        // è·å–è®¤è¯å¯¹è±¡
        CustomUser customUser = (CustomUser) authResult.getPrincipal();
        // ç”Ÿæˆtoken
        String token = JwtHelper.createToken(customUser.getSysUser().getId(), customUser.getSysUser().getUsername());
        // è¿”å›
        Map<String, Object> map = new HashMap<>();
        map.put("token", token);
        ResponseUtil.out(response, Result.ok(map));  // ğŸ”–å†™æ³•å¥‡æ€ªéœ€è¦æ”¹é€ 
    }
    /**
     * è®¤è¯å¤±è´¥è°ƒç”¨
     */
    @Override
    protected void unsuccessfulAuthentication(HttpServletRequest request, HttpServletResponse response, AuthenticationException e) throws IOException, ServletException {
        if(e.getCause() instanceof RuntimeException) {
            ResponseUtil.out(response, Result.build(null, 204, e.getMessage()));
        } else {
            ResponseUtil.out(response, Result.build(null, ResultCodeEnum.LOGIN_MOBLE_ERROR));
        }
    }
```

æ·»åŠ å·¥å…·ç±»ï¼šResponseUtil

æ·»åŠ æ¨¡å—ï¼šcommon-util

```java
package com.atguigu.common.util;

import com.atguigu.common.result.Result;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.springframework.http.HttpStatus;
import org.springframework.http.MediaType;

import javax.servlet.http.HttpServletResponse;
import java.io.IOException;

public class ResponseUtil {

    public static void out(HttpServletResponse response, Result r) {
        ObjectMapper mapper = new ObjectMapper();
        response.setStatus(HttpStatus.OK.value());
        response.setContentType(MediaType.APPLICATION_JSON_UTF8_VALUE);
        try {
            mapper.writeValue(response.getWriter(), r);
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
}
```

##### 2.2.7ã€è®¤è¯è§£ætoken

P101

å› ä¸ºç”¨æˆ·ç™»å½•çŠ¶æ€åœ¨tokenä¸­å­˜å‚¨åœ¨å®¢æˆ·ç«¯ï¼Œæ‰€ä»¥æ¯æ¬¡è¯·æ±‚æ¥å£è¯·æ±‚å¤´æºå¸¦tokenï¼Œ åå°é€šè¿‡è‡ªå®šä¹‰tokenè¿‡æ»¤å™¨æ‹¦æˆªè§£ætokenå®Œæˆè®¤è¯å¹¶å¡«å……ç”¨æˆ·ä¿¡æ¯å®ä½“ã€‚

```java
/**
 * è®¤è¯è§£ætokenè¿‡æ»¤å™¨
 * @author andyron
 **/
public class TokenAuthenticationFilter extends OncePerRequestFilter {
    public TokenAuthenticationFilter() {
    }

    @Override
    protected void doFilterInternal(HttpServletRequest request, HttpServletResponse response, FilterChain chain) throws ServletException, IOException {
        logger.info("uri:" + request.getRequestURI());
        // å¦‚æœæ˜¯ç™»å½•æ¥å£ï¼Œç›´æ¥æ”¾è¡Œ
        if ("/admin/system/index/login".equals(request.getRequestURI())) {
            chain.doFilter(request, response);
            return;
        }
        UsernamePasswordAuthenticationToken authentication = getAuthentication(request);
        if (authentication != null) {
            SecurityContextHolder.getContext().setAuthentication(authentication);
            chain.doFilter(request, response);
        } else {
            ResponseUtil.out(response, Result.build(null, ResultCodeEnum.PERMISSION));
        }
    }

    private UsernamePasswordAuthenticationToken getAuthentication(HttpServletRequest request) {
        String token = request.getHeader("token");
        logger.info("token:" + token);
        if (!StringUtils.isEmpty(token)) {
            String username = JwtHelper.getUsername(token);
            logger.info("username:" + username);
            if (!StringUtils.isEmpty(username)) {
                return new UsernamePasswordAuthenticationToken(username, null, Collections.emptyList());
            }
        }
        return null;
    }
}
```

##### 2.2.8ã€é…ç½®ç”¨æˆ·è®¤è¯



ä¿®æ”¹WebSecurityConfigé…ç½®ç±»

```java
/**
 * å…¨å±€æ€§é…ç½®
 * @author andyron
 **/
@Configuration
@EnableWebSecurity // @EnableWebSecurityæ˜¯å¼€å¯SpringSecurityçš„é»˜è®¤è¡Œä¸º
public class WebSecurityConfig extends WebSecurityConfigurerAdapter {
    @Autowired
    private UserDetailsService userDetailsService;
    @Autowired
    private CustomMd5Password customMd5Password;

    @Bean
    @Override
    protected AuthenticationManager authenticationManager() throws Exception {
        return super.authenticationManager();
    }
    /**
     * é…ç½®å“ªäº›è¯·æ±‚ä¸æ‹¦æˆªã€‚
     * æ’é™¤swaggerç›¸å…³è¯·æ±‚
     */
    @Override
    public void configure(WebSecurity web) throws Exception {
        web.ignoring().antMatchers("/favicon.ico","/swagger-resources/**", "/webjars/**", "/v2/**",
                "/swagger-ui.html/**", "/doc.html");
    }

    @Override
    protected void configure(HttpSecurity http) throws Exception {
        // è¿™æ˜¯é…ç½®çš„å…³é”®ï¼Œå†³å®šå“ªäº›æ¥å£å¼€å¯é˜²æŠ¤ï¼Œå“ªäº›æ¥å£ç»•è¿‡é˜²æŠ¤
        // å…³é—­csrf
        http.csrf().disable()
                // å¼€å¯è·¨åŸŸä»¥ä¾¿å‰ç«¯è°ƒç”¨æ¥å£
                .cors().and()
                .authorizeRequests()
                // æŒ‡å®šæŸäº›æ¥å£ä¸éœ€è¦é€šè¿‡éªŒè¯å³å¯è®¿é—®ã€‚ç™»é™†æ¥å£è‚¯å®šæ˜¯ä¸éœ€è¦è®¤è¯çš„
                .antMatchers("/admin/system/index/login").permitAll()
                // å…¶å®ƒæ‰€æœ‰æ¥å£éœ€è¦è®¤è¯æ‰èƒ½è®¿é—®
                .anyRequest().authenticated()
                .and()
                // TokenAuthenticationFilteræ”¾åˆ°UsernamePasswordAuthenticationFilterçš„å‰é¢ï¼Œ
                // è¿™æ ·åšå°±æ˜¯ä¸ºäº†é™¤äº†ç™»å½•çš„æ—¶å€™å»æŸ¥è¯¢æ•°æ®åº“å¤–ï¼Œå…¶ä»–æ—¶å€™éƒ½ç”¨tokenè¿›è¡Œè®¤è¯ã€‚
                .addFilterBefore(new TokenAuthenticationFilter(), UsernamePasswordAuthenticationFilter.class)
                .addFilter(new TokenLoginFilter(authenticationManager()));

        // ç¦ç”¨session
        http.sessionManagement().sessionCreationPolicy(SessionCreationPolicy.STATELESS);
    }

    @Override
    protected void configure(AuthenticationManagerBuilder auth) throws Exception {
        // æŒ‡å®šUserDetailServiceå’ŒåŠ å¯†å™¨
        auth.userDetailsService(userDetailsService).passwordEncoder(customMd5Password);
    }
}
```

**è¯´æ˜ï¼š**

**1ã€æˆ‘ä»¬æ˜¯å‰åç«¯åˆ†ç¦»é¡¹ç›®ï¼Œä½¿ç”¨`jwt`ç”Ÿæˆtoken ï¼Œå³ç”¨æˆ·çŠ¶æ€ä¿å­˜åœ¨å®¢æˆ·ç«¯ä¸­ï¼Œå‰åç«¯äº¤äº’é€šè¿‡apiæ¥å£ `æ— session`ç”Ÿæˆï¼Œæ‰€ä»¥æˆ‘ä»¬ä¸éœ€è¦é…ç½®`formLogin`ï¼Œsessionç¦ç”¨**

**2ã€åœ¨æµè§ˆå™¨è®¿é—®ï¼šhttp://localhost:8800/admin/system/sysRole/findAll**

```
{
    "code": 209,
    "message": "æ²¡æœ‰æƒé™",
    "data": null
}
```

##### 2.2.9ã€é€šè¿‡swaggeræµ‹è¯•ç™»å½•

http://localhost:8800/doc.html

åœ¨ç›¸åº”çš„è‡ªå®šä¹‰ç»„ä»¶è®¾ç½®æ–­ç‚¹ï¼ŒæŸ¥çœ‹æ˜¯å¦æŒ‰ç…§é¢„æœŸæ‰§è¡Œã€‚

1ã€å…ˆè¾“å…¥æ­£ç¡®çš„ç”¨æˆ·åä¸å¯†ç 

2ã€è¾“å…¥é”™è¯¯çš„ç”¨æˆ·åä¸å¯†ç 

ç»“è®ºï¼šè·Ÿé¢„æœŸä¸€è‡´

ğŸ”–p102 æƒé™å‰ç«¯åç«¯ä»£ç éƒ½éœ€è¦æµ‹è¯•



### 3 ç”¨æˆ·æˆæƒ



## å…¶ä»–åŠŸèƒ½

å…¶ä»–åŠŸèƒ½ï¼šéƒ¨é—¨ç®¡ç†ã€å²—ä½ç®¡ç†ã€æ—¥å¿—ç®¡ç†ï¼ˆç™»å½•æ—¥å¿—ã€æ“ä½œæ—¥å¿—ï¼‰



### éƒ¨é—¨ç®¡ç†



### å²—ä½ç®¡ç†



### ç™»å½•æ—¥å¿—



### æ“ä½œæ—¥å¿—





```
{
  "description": "æµ‹è¯•",
  "id": 0,
  "name": "jack",
  "password": "123456",
  "phone": "15121546639",
  "username": "jack"
}
```

